---
title: "Semi quantitative proteomics enables mapping of global neutrophil dynamics following influenza virus infection"
date: "2019-01-25"
author: Chuanxin Liu
categories:
- Research
- Coding
tags:
- research
- publication
image: "https://8heddw.ch.files.1drv.com/y4mSLrpvgdAbg0tTkx3RhzfRqpLs7L6xDT3U5NO7USxOLxnX0XjJFEg5j90FI-Xw9qovOyAX-e92EKz2hUT8QWsdLX2vB5J0KsxqxeWhgZQvT2O0LKq9YezyECWyCl5mZcAF_x2V5YpMXPUsK0VmA4wvUZui9_bQxt8RlEtQx-XqixRUR6kcIWCULI5HnhGhgQs?width=1920&height=1080&cropmode=none"
output:
  blogdown::html_page:
    dev: "svg" ## set the default output device to svg
    toc: true
---


<div id="TOC">
<ul>
<li><a href="#source-code-and-dataset-availability">Source code and dataset availability</a></li>
<li><a href="#prerequisite">Prerequisite</a></li>
<li><a href="#analysis-of-neutrophil-proteome-at-homeostasis-or-following-a-lethal-iav-infection">Analysis of neutrophil proteome at homeostasis or following a lethal IAV infection</a><ul>
<li><a href="#raw-data-cleaning">Raw data cleaning</a></li>
<li><a href="#visualization-of-pick-up-proteins-in-independent-experiments-and-biological-replicates">Visualization of pick-up proteins in independent experiments and biological replicates</a></li>
<li><a href="#overall-impression-of-proteome-dataset">Overall impression of proteome dataset</a></li>
<li><a href="#analysis-of-proteins-with-significant-abundance-changes">Analysis of proteins with significant abundance changes</a></li>
<li><a href="#ibaq-intensity-ranking">iBAQ intensity ranking</a></li>
</ul></li>
<li><a href="#analysis-of-bal-neutrophil-proteome-changes-following-different-doses-of-influenza-infection-or-bacterial-infection">Analysis of BAL neutrophil proteome changes following different doses of influenza infection or bacterial infection</a><ul>
<li><a href="#raw-data-cleaning-1">Raw data cleaning</a></li>
<li><a href="#overall-impression-of-datasets">Overall impression of datasets</a></li>
</ul></li>
</ul>
</div>

<div id="source-code-and-dataset-availability" class="section level2">
<h2>Source code and dataset availability</h2>
<p>Source code is hosted on <a href="https://github.com/codetrainee/Neutrophil-systems-biology">github</a></p>
</div>
<div id="prerequisite" class="section level2">
<h2>Prerequisite</h2>
<p>We first loaded libraries required for analysis.</p>
<pre class="r"><code>pacman::p_load(tidyverse,
               magrittr,
               ggrepel,
               ggthemes,
               eulerr,
               ComplexHeatmap,
               gridExtra,
               factoextra,
               data.table,
               cowplot,
               egg,
               gridExtra,
               RColorBrewer,
               ggalluvial,
               glue,
               customLayout,
               org.Mm.eg.db,
               AnnotationDbi,
               ggthemr,
               scatterpie
               )</code></pre>
<p>The theme for figures generated by ggplot2 was set to <code>dust</code> style from <a href="https://github.com/cttobin/ggthemr">ggthemr</a> packages.</p>
<pre class="r"><code>ggthemr(&quot;dust&quot;)</code></pre>
<pre><code>## Warning: New theme missing the following elements: panel.grid, plot.tag,
## plot.tag.position</code></pre>
<p>To have a tidy output, the figures were centered and message and warning was suppressed by defaults.</p>
<pre class="r"><code>knitr::opts_chunk$set(fig.align=&#39;center&#39;,
                      message=FALSE,
                      warning=FALSE)</code></pre>
<p>All data were stored under the below folders and raw datasets can be found in the <a href="##Source-code-and-dataset-availability">Source code and dataset availability</a></p>
<pre class="r"><code>path &lt;- &quot;data/Neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection/&quot;</code></pre>
<p>In the raw datasets, there are plenty of <code>NA</code> values requiring to be cleaned before downstream analyses and we then customised a function for removing these unwanted pick-ups.</p>
<p>To survive the filter step, a pick-up protein should meet following requirements:</p>
<ul>
<li>should be detected in at least one comparison group.</li>
<li>should be picked up in three independent replicates.</li>
</ul>
<pre class="r"><code>filter_valid &lt;-
  function(df) {
    matrix &lt;- apply(df, MARGIN = 2, function(x) !is.na(x))

    log_test_valid &lt;- (apply(matrix, MARGIN = 1, prod) == 0) == ((apply(matrix, MARGIN = 1, sum) == 0))

    log_test_na &lt;- !((apply(matrix, MARGIN = 1, prod) == 0) &amp; ((apply(matrix, MARGIN = 1, sum) == 0)))

    log_test &lt;- (log_test_valid + log_test_na) == 2

    return(log_test)
  }</code></pre>
</div>
<div id="analysis-of-neutrophil-proteome-at-homeostasis-or-following-a-lethal-iav-infection" class="section level2">
<h2>Analysis of neutrophil proteome at homeostasis or following a lethal IAV infection</h2>
<p>The analysis pipeline included 3 experiments. The first two were combined together to identify neutrophil-derived markers in an 1000 pfu PR8 influenza infection compared to PBS treated control. The third experiment compared the neutrophil proteome in different doses of influenza infection and bacterial infection.</p>
<div id="raw-data-cleaning" class="section level3">
<h3>Raw data cleaning</h3>
<p>We first loaded dataset from two experiments and removed the contamination respectively.</p>
<pre class="r"><code>raw_data_nov &lt;-
  read_tsv(glue(path, &quot;20170428-Proteomics-201611-Requant.txt&quot;)) %&gt;%
  ## Remove the contamination and duplicates
  filter(is.na(.$`Only identified by site`) &amp; is.na(.$Reverse) &amp; is.na(.$`Potential contaminant`) &amp; `Razor + unique peptides` &gt;= 1)

raw_data_dec &lt;-
  read_tsv(glue(path, &quot;20170428-Proteomics-201612-Requant.txt&quot;)) %&gt;%
  ## Remove the contamination and duplicates
  filter(is.na(.$`Only identified by site`) &amp; is.na(.$Reverse) &amp; is.na(.$`Potential contaminant`) &amp; `Razor + unique peptides` &gt;= 1)</code></pre>
<p>The dataset was annotated by labelling samples. Missing values were filtered out using customised functions. The label details are below:</p>
<table>
<caption><strong>Experiment 1 Biological replicate 1</strong></caption>
<thead>
<tr class="header">
<th>Labelling</th>
<th>Sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Light (L)</td>
<td>1000 PFU PR8 BM neutrophil</td>
</tr>
<tr class="even">
<td>Medium (M)</td>
<td>1000 PFU PR8 Blood neutrophil</td>
</tr>
<tr class="odd">
<td>Heavy (H)</td>
<td>1000 PFU PR8 BAL neutrophil</td>
</tr>
</tbody>
</table>
<table>
<caption><strong>Experiment 1 Biological replicate 2</strong></caption>
<thead>
<tr class="header">
<th>Labelling</th>
<th>Sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Light (L)</td>
<td>1000 PFU PR8 BAL neutrophil</td>
</tr>
<tr class="even">
<td>Medium (M)</td>
<td>1000 PFU PR8 BM neutrophil</td>
</tr>
<tr class="odd">
<td>Heavy (H)</td>
<td>1000 PFU PR8 Blood neutrophil</td>
</tr>
</tbody>
</table>
<table>
<caption><strong>Experiment 1 Biological replicate 3</strong></caption>
<thead>
<tr class="header">
<th>Labelling</th>
<th>Sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Light (L)</td>
<td>1000 PFU PR8 Blood neutrophil</td>
</tr>
<tr class="even">
<td>Medium (M)</td>
<td>1000 PFU PR8 BAL neutrophil</td>
</tr>
<tr class="odd">
<td>Heavy (H)</td>
<td>1000 PFU PR8 BM neutrophil</td>
</tr>
</tbody>
</table>
<table>
<caption><strong>Experiment 2 Biological replicate 1</strong></caption>
<thead>
<tr class="header">
<th>Labelling</th>
<th>Sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Light (L)</td>
<td>PBS BM neutrophil</td>
</tr>
<tr class="even">
<td>Medium (M)</td>
<td>PBS Blood neutrophil</td>
</tr>
<tr class="odd">
<td>Heavy (H)</td>
<td>1000 PFU PR8 BM neutrophil</td>
</tr>
</tbody>
</table>
<table>
<caption><strong>Experiment 2 Biological replicate 2</strong></caption>
<thead>
<tr class="header">
<th>Labelling</th>
<th>Sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Light (L)</td>
<td>1000 PFU PR8 BM neutrophil</td>
</tr>
<tr class="even">
<td>Medium (M)</td>
<td>PBS BM neutrophil</td>
</tr>
<tr class="odd">
<td>Heavy (H)</td>
<td>PBS Blood neutrophil</td>
</tr>
</tbody>
</table>
<table>
<caption><strong>Experiment 2 Biological replicate 3</strong></caption>
<thead>
<tr class="header">
<th>Labelling</th>
<th>Sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Light (L)</td>
<td>PBS Blood neutrophil</td>
</tr>
<tr class="even">
<td>Medium (M)</td>
<td>1000 PFU PR8 neutrophil</td>
</tr>
<tr class="odd">
<td>Heavy (H)</td>
<td>PBS BM neutrophil</td>
</tr>
</tbody>
</table>
<pre class="r"><code>data_nov &lt;-
  raw_data_nov %&gt;%
  ## select the required columns
  dplyr::select(matches(&quot;Gene names|normalized Rep&quot;)) %&gt;%
  magrittr::set_colnames(c(
    &quot;Gene_names&quot;,
    &quot;C_1000_PFU_PR8_Blood_vs_1000_PFU_PR8_BM_1&quot;,
    &quot;B_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_BM_2_invert&quot;,
    &quot;A_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_Blood_3&quot;,
    &quot;B_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_BM_1&quot;,
    &quot;A_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_Blood_2_invert&quot;,
    &quot;C_1000_PFU_PR8_Blood_vs_1000_PFU_PR8_BM_3_invert&quot;,
    &quot;A_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_Blood_1&quot;,
    &quot;C_1000_PFU_PR8_Blood_vs_1000_PFU_PR8_BM_2&quot;,
    &quot;B_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_BM_3_invert&quot;
  )) %&gt;%
  dplyr::select(order(colnames(.))) %&gt;%
  ## Remove the gene names were not identified.
  filter(!is.na(Gene_names)) %&gt;%
  ## Some duplicate gene names were removed.
  distinct(Gene_names, .keep_all = TRUE) %&gt;%
  ## In the dimethyl labelling, the comparision ratio sometimes were inverted and required inversion.
  mutate_at(vars(contains(&quot;invert&quot;)), funs(1 / .)) %&gt;%
  ## Remove introduced the `invert` in the column names.
  magrittr::set_colnames(sapply(colnames(.), function(x) str_replace(x, &quot;_invert&quot;, &quot;&quot;))) %&gt;%
  ## log transformation
  mutate_at(vars(-Gene_names), funs(log2(.))) %&gt;%
  ## converted to data.table for filter.
  as.data.table()

valid_list &lt;- c(&quot;tissue&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;)
for (i in valid_list) {
  data_nov[,
           sprintf(&quot;rep_%s_valid&quot;, i) := filter_valid(.SD),
           .SDcols = names(data_nov) %like% ifelse(i == &quot;tissue&quot;, &quot;^[ABCabc]_.+_[0-9]$&quot;, sprintf(&quot;_%s$&quot;, i))]
}

data_nov_stat &lt;-
  data_nov %&gt;%
  filter(rep_tissue_valid == TRUE) %&gt;%
  dplyr::select(-matches(&quot;valid$&quot;))

## Annotations were similar to the preparation step for the above experiment.
data_dec &lt;-
  raw_data_dec %&gt;%
  dplyr::select(matches(&quot;Gene names|normalized Rep&quot;)) %&gt;%
  magrittr::set_colnames(c(
    &quot;Gene_names&quot;,
    &quot;c_PBS_Blood_vs_PBS_BM_1&quot;,
    &quot;b_1000_PFU_PR8_BM_vs_PBS_BM_2_invert&quot;,
    &quot;a_1000_PFU_PR8_BM_vs_PBS_Blood_3&quot;,
    &quot;b_1000_PFU_PR8_BM_vs_PBS_BM_1&quot;,
    &quot;a_1000_PFU_PR8_BM_vs_PBS_Blood_2_invert&quot;,
    &quot;c_PBS_Blood_vs_PBS_BM_3_invert&quot;,
    &quot;a_1000_PFU_PR8_BM_vs_PBS_Blood_1&quot;,
    &quot;c_PBS_Blood_vs_PBS_BM_2&quot;,
    &quot;b_1000_PFU_PR8_BM_vs_PBS_BM_3_invert&quot;
  )) %&gt;%
  dplyr::select(order(colnames(.))) %&gt;%
  filter(!is.na(Gene_names)) %&gt;%
  distinct(Gene_names, .keep_all = TRUE) %&gt;%
  mutate_at(vars(contains(&quot;invert&quot;)), funs(1 / .)) %&gt;%
  magrittr::set_colnames(sapply(colnames(.), function(x) str_replace(x, &quot;_invert&quot;, &quot;&quot;))) %&gt;%
  mutate_at(vars(-Gene_names), funs(log2(.))) %&gt;%
  as.data.table()

for (i in valid_list) {
  data_dec[,
           sprintf(&quot;rep_%s_valid&quot;, i) := filter_valid(.SD),
           .SDcols = names(data_dec) %like% ifelse(i == &quot;tissue&quot;, &quot;^[ABCabc]_.+_[0-9]$&quot;, sprintf(&quot;_%s$&quot;, i))]
}

data_dec_stat &lt;-
  data_dec %&gt;%
  filter(rep_tissue_valid == TRUE) %&gt;%
  dplyr::select(-matches(&quot;valid$&quot;))</code></pre>
<p>Proteins detected in both experiments were kept and statistics tests were applied. Protein with a fold change greater than 2 and p value less than 0.05 in at least one comparison group was considered significant in protein abundance change.</p>
<pre class="r"><code>all_stat &lt;-
  ## combine two experiments
  inner_join(data_nov_stat, data_dec_stat) %&gt;%
  ## Remove the comparison between 1000 PFU PR8 BM and PBS Blood. The ideal comparison should be 1000 PFU PR8 Blood
  ## vs PBS Blood. Due to the technique limitations, we can&#39;t achieve the goal.
  dplyr::select(-matches(&quot;1000_PFU_PR8_BM_vs_PBS_Blood&quot;)) %&gt;%
  as.data.table()

sig_list &lt;- c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;b&quot;, &quot;c&quot;)

for (i in sig_list) {
  all_stat[,
           c(sprintf(&quot;%s_p_value&quot;, i),
             sprintf(&quot;%s_mean&quot;, i))   := list(apply(.SD, 1, function(x) t.test(x)$p.value),
                                              apply(.SD, 1, function(x) mean(x))),
           .SDcols = names(all_stat) %like% sprintf(&quot;^%s.+[0-9]$&quot;, i)]
}

all_stat &lt;-
  all_stat %&gt;%
  ## The proteins with fold change &gt; 2 and p value &lt; 0.05 were selected.
  mutate(Sig_diff = (A_p_value &lt; 0.05 &amp; abs(A_mean) &gt; 1) | (B_p_value &lt; 0.05 &amp; abs(B_mean) &gt; 1) | (C_p_value &lt; 0.05 &amp; abs(C_mean) &gt; 1) | (b_p_value &lt; 0.05 &amp; abs(b_mean) &gt; 1) | (c_p_value &lt; 0.05 &amp; abs(c_mean) &gt; 1))</code></pre>
</div>
<div id="visualization-of-pick-up-proteins-in-independent-experiments-and-biological-replicates" class="section level3">
<h3>Visualization of pick-up proteins in independent experiments and biological replicates</h3>
<p>Before moving on, we checked all proteins identified in all replicates and visualized them via Venn Diagram.</p>
<pre class="r"><code>## Visualise the pick-up difference between independent replicates and experiments.
## for the first experiment
data_nov_replicate &lt;-
  data_nov %&gt;%
  filter(rep_1_valid + rep_2_valid + rep_3_valid &gt; 0) %&gt;%
  dplyr::select(matches(&quot;^rep_[0-9]{1}_valid$&quot;)) %&gt;%
  ## Venn diagram was drawn with [eulerr](https://github.com/jolars/eulerr)
  euler(.) %&gt;%
  plot(.,
       main = &quot;Experiment 1&quot;,
       quantities = TRUE,
       fill = c(&quot;#f1a340&quot;, &quot;#f7f7f7&quot;, &quot;#998ec3&quot;),
       legend = list(side = &quot;bottom&quot;)
  )

## for the second experiment
data_dec_replicate &lt;-
  data_dec %&gt;%
  filter(rep_1_valid + rep_2_valid + rep_3_valid &gt; 0) %&gt;%
  dplyr::select(matches(&quot;^rep_[0-9]{1}_valid$&quot;)) %&gt;%
  euler(.) %&gt;%
  plot(.,
       main = &quot;Experiment 2&quot;,
       quantities = TRUE,
       fill = c(&quot;#d8b365&quot;, &quot;#f5f5f5&quot;, &quot;#5ab4ac&quot;),
       legend = list(side = &quot;bottom&quot;)
  )

## combine two experiment
all_replicate &lt;-
  full_join(
    data_nov %&gt;%
      mutate(Nov = (rep_1_valid * rep_2_valid * rep_3_valid == 1)) %&gt;%
      dplyr::select(Gene_names, Nov),
    data_dec %&gt;%
      mutate(Dec = (rep_1_valid * rep_2_valid * rep_3_valid == 1)) %&gt;%
      dplyr::select(Gene_names, Dec)
  ) %&gt;%
  dplyr::select(-Gene_names)
all_replicate[is.na(all_replicate)] &lt;- FALSE

all_replicate &lt;-
  all_replicate %&gt;%
  euler(.) %&gt;%
  plot(.,
       main = &quot;Two experiments combined&quot;,
       quantities = TRUE,
       fill = c(&quot;#fc8d59&quot;, &quot;#91bfdb&quot;),
       legend = list(side = &quot;bottom&quot;)
  )

## customise the layout of venn diagrams using [customLayout](https://github.com/zzawadz/customLayout)
Venn_lay &lt;- lay_new(
  matrix(1:2, nc = 2),
  widths = c(1, 1)
)

Venn_lay2 &lt;- lay_new(matrix(1))

Venn_cl &lt;- lay_bind_row(Venn_lay, Venn_lay2, heights = c(1.2, 1))

lay_grid(list(data_nov_replicate, data_dec_replicate, all_replicate), Venn_cl)</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/Venn-Diagram-1.svg" width="768" style="display: block; margin: auto;" /></p>
</div>
<div id="overall-impression-of-proteome-dataset" class="section level3">
<h3>Overall impression of proteome dataset</h3>
<p>To examine their protein abundance pattern similarity, PCA analysis was conducted.</p>
<pre class="r"><code>set.seed(123)
all_stat_pca &lt;-
  all_stat %&gt;%
  dplyr::select(matches(&quot;_vs_&quot;)) %&gt;%
  as.matrix() %&gt;%
  prcomp(.)

## PCA results QC
fviz_eig(all_stat_pca)</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/PCA-analysis-1.svg" width="768" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## caculate the variances explained by each principle component
all_stat_pca_pov &lt;- all_stat_pca$sdev^2 / sum(all_stat_pca$sdev^2)

## extract the dataframe from PCA analysis
all_stat_pca_df &lt;- all_stat_pca$rotation %&gt;%
  as.data.frame() %&gt;%
  mutate(Sample = row.names(.),
         Comparison = str_replace_all(str_extract(Sample, &quot;(?&lt;=[A-Za-z]{1}_).+(?=_[0-9]{1})&quot;), &quot;_&quot;, &quot; &quot;),          batch = str_extract(Sample, &quot;[0-9]{1}$&quot;))

## visualise the PCA using ggplot2
ggplot(all_stat_pca_df, aes(PC1, PC2, colour = Comparison)) +
  geom_point(size = 4) +
  labs(
    x = sprintf(&quot;PC1: %.2f %% Variance&quot;, all_stat_pca_pov[[1]] * 100),
    y = sprintf(&quot;PC2: %.2f %% Variance&quot;, all_stat_pca_pov[[2]] * 100)
  ) +
  scale_colour_manual(values = brewer.pal(6, &quot;RdBu&quot;)[1:5]) +
  theme_classic() +
  theme(aspect.ratio = 1,
        legend.position = &quot;bottom&quot;,
        panel.border = element_rect(fill = &quot;transparent&quot;),
        legend.direction = &quot;vertical&quot;
        )</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/PCA-analysis-2.svg" width="768" style="display: block; margin: auto;" /></p>
<p>Another way to visualize all protein abundance pattern is the heatmap.</p>
<pre class="r"><code>## heatmaps were generated by [ComplexHeatmap](https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html)
## construct the matrix for heatmap input
all_stat_heatmap_matrix &lt;-
  all_stat %&gt;%
  dplyr::select(matches(&quot;Gene|_vs_&quot;)) %&gt;%
  as.matrix() %&gt;%
  `rownames&lt;-`(.[, &quot;Gene_names&quot;]) %&gt;%
  `colnames&lt;-`(sapply(colnames(.), function(x) str_replace(x, &quot;^[A-Za-z]{1}_&quot;, &quot;&quot;))) %&gt;%
  `colnames&lt;-`(sapply(colnames(.), function(x) str_replace_all(x, &quot;_&quot;, &quot; &quot;))) %&gt;%
  .[, !colnames(.) %in% c(&quot;Gene names&quot;)] %&gt;%
  `class&lt;-`(&quot;numeric&quot;)

## Same with heatmap for sig proteins
all_stat_heatmap_ha_df &lt;-
  data.frame(type = colnames(all_stat_heatmap_matrix)) %&gt;%
  mutate(Comparison = str_extract(type, &quot;.+(?= [0-9]{1}$)&quot;)) %&gt;%
  dplyr::select(-type)

## construct the customised annotation
all_stat_heatmap_ha &lt;-
  columnAnnotation(
    df = all_stat_heatmap_ha_df,
    col = list(Comparison = setNames(
      brewer.pal(6, &quot;RdBu&quot;)[1:5],
      sort(unique(all_stat_heatmap_ha_df$Comparison))
    ) %&gt;% sort(.)),
    annotation_legend_param = list(Comparison = list(
      nrow = 3,
      title = &quot;Comparison&quot;,
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 6)
    ))
  )

## set the seed for reproducibility
set.seed(123)

all_stat_heatmap &lt;-
  Heatmap(all_stat_heatmap_matrix,
    top_annotation = all_stat_heatmap_ha,
    heatmap_legend_param = list(
      title = &quot;Log2 Fold Change&quot;,
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 6),
      legend_direction = &quot;horizontal&quot;,
      legend_width = unit(1.5, &quot;in&quot;)
    ),
    show_column_names = FALSE,
    show_row_names = FALSE,
    show_row_dend = FALSE
  )

draw(all_stat_heatmap, heatmap_legend_side = &quot;bottom&quot;, annotation_legend_side = &quot;bottom&quot;)

for (an in colnames(all_stat_heatmap_ha_df)) {
  decorate_annotation(an, {
    ## annotation names on the left
    grid.text(an,
      unit(1, &quot;npc&quot;) + unit(2, &quot;mm&quot;),
      0.6,
      default.units = &quot;npc&quot;,
      just = &quot;left&quot;,
      gp = gpar(fontsize = 8)
    )
  })
}</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/heatmap-for-all-proteins-1.svg" width="576" style="display: block; margin: auto;" /></p>
<p>We submitted the identified proteins to DAVID database to investigate the cellular compartments they belong to.</p>
<pre class="r"><code>## cell compartment GO analysis
all_stat_gene &lt;- all_stat %&gt;% pull(Gene_names)
all_stat_gene_ENTREZID &lt;- mapIds(org.Mm.eg.db,
                                 keys = all_stat_gene,
                                 column = &quot;ENTREZID&quot;,
                                 keytype = &quot;SYMBOL&quot;,
                                 multiVals = &quot;first&quot;) %&gt;% na.omit

## gene list was searched against DAVID database https://david.ncifcrf.gov
david_gene &lt;- readr::read_tsv(&quot;https://david.ncifcrf.gov/data/download/chart_94533FFDBC301547014607513.txt&quot;)

## save it locally
## write_tsv(david_gene, glue(path, &quot;all-stat-gene-DAVID-database-GO-cell-compartment.txt&quot;))

p_go_cell_compartment &lt;-
  ggplot(david_gene %&gt;%
         filter(FDR &lt; 0.05) %&gt;%
         arrange(Count) %&gt;%
         mutate(Term = factor(Term, Term)),
       aes(Term, Count)) +
  geom_bar(stat = &quot;identity&quot;,
           fill = &quot;#cccccc&quot;) +
  scale_y_continuous(breaks = seq(0, 1500, 300),
                     limits = c(0, 1600),
                     expand = c(0, 0)) +
  coord_flip()

p_go_cell_compartment</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/david-GO-analysis-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="analysis-of-proteins-with-significant-abundance-changes" class="section level3">
<h3>Analysis of proteins with significant abundance changes</h3>
<p>We moved to investigate the proteins with different abundance in at least one comparison group. First the cluster was defined by k-means clustering and 9 was chosen.</p>
<pre class="r"><code>## Annotation is same with heatmap for all proteins

sig_stat_heatmap_df &lt;-
  all_stat %&gt;%
  filter(Sig_diff == TRUE) %&gt;%
  dplyr::select(matches(&quot;Gene|_vs_&quot;)) %&gt;%
  `colnames&lt;-`(sapply(colnames(.), function(x) str_replace(x, &quot;^[A-Za-z]{1}_&quot;, &quot;&quot;))) %&gt;%
  `colnames&lt;-`(sapply(colnames(.), function(x) str_replace_all(x, &quot;_&quot;, &quot; &quot;)))

## determine the potential cluster numbers
fviz_nbclust(sig_stat_heatmap_df %&gt;% dplyr::select(-matches(&quot;Gene&quot;)),
  kmeans,
  method = &quot;wss&quot;
)</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/potential-cluster-number-1.svg" width="576" style="display: block; margin: auto;" /></p>
<p>The heatmap was generated with 9 clusters.</p>
<pre class="r"><code>sig_stat_heatmap_df &lt;-
  sig_stat_heatmap_df %&gt;%
  mutate(cluster = kmeans(sig_stat_heatmap_df %&gt;% dplyr::select(-matches(&quot;Gene&quot;)), 9)$cluster)

sig_stat_heatmap_matrix &lt;-
  sig_stat_heatmap_df %&gt;%
  as.matrix() %&gt;%
  `rownames&lt;-`(.[, &quot;Gene names&quot;]) %&gt;%
  .[, !colnames(.) %in% c(&quot;Gene names&quot;)] %&gt;%
  `class&lt;-`(&quot;numeric&quot;)

sig_stat_heatmap_ha_row &lt;-
  rowAnnotation(
    df = sig_stat_heatmap_df %&gt;% dplyr::select(cluster) %&gt;% as.data.frame(),
    col = list(cluster = setNames(
      brewer.pal(9, &quot;BrBG&quot;),
      unique(sig_stat_heatmap_df$cluster) %&gt;% sort(.)
    )),
    width = unit(0.2, &quot;in&quot;),
    annotation_legend_param = list(
      nrow = 1,
      title = &quot;Cluster&quot;,
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 8),
      legend_width = unit(1, &quot;in&quot;)
    )
  )

set.seed(123)
sig_stat_heatmap &lt;-
  Heatmap(sig_stat_heatmap_matrix[, !colnames(sig_stat_heatmap_matrix) %in% c(&quot;cluster&quot;)],
    top_annotation = all_stat_heatmap_ha,
    heatmap_legend_param = list(
      title = &quot;Log2 Fold Change&quot;,
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 6),
      legend_direction = &quot;horizontal&quot;,
      legend_width = unit(1.5, &quot;inch&quot;)
    ),
    show_column_names = FALSE,
    show_row_dend = FALSE,
    combined_name_fun = NULL,
    row_names_gp = gpar(fontsize = 6),
    split = sig_stat_heatmap_matrix[, &quot;cluster&quot;],
    gap = unit(1.5, &quot;mm&quot;)
  )

draw(sig_stat_heatmap_ha_row + sig_stat_heatmap, heatmap_legend_side = &quot;bottom&quot;, annotation_legend_side = &quot;bottom&quot;)

for (an in colnames(all_stat_heatmap_ha_df)) {
  decorate_annotation(an, {
    ## annotation names on the left
    grid.text(an,
      unit(1, &quot;npc&quot;) + unit(2, &quot;mm&quot;),
      0.6,
      default.units = &quot;npc&quot;,
      just = &quot;left&quot;,
      gp = gpar(fontsize = 8)
    )
  })
}</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/heatmap-for-signifant-1.svg" width="576" style="display: block; margin: auto;" /></p>
<p>All analyses above were only about all proteins from different comparison group. To identify proteins in each comparison group, we visualized data with volcano plots. The dataset was first cleaned for the subsequent visualization.</p>
<pre class="r"><code>all_stat_volcano &lt;- all_stat %&gt;% as.data.table()
Comparison_list &lt;- c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;b&quot;, &quot;c&quot;)
for (i in seq_along(Comparison_list)) {
  logical_p &lt;- paste0(Comparison_list[i], &quot;_p_value&quot;)
  logical_mean &lt;- paste0(Comparison_list[i], &quot;_mean&quot;)
  all_stat_volcano[, Comparison_list[i] := ifelse(get(logical_p) &lt;= 0.05 &amp; get(logical_mean) &gt;= 1, &quot;up&quot;, ifelse(get(logical_p) &lt;= 0.05 &amp; get(logical_mean) &lt;= -1, &quot;down&quot;, &quot;ns&quot;))]
}</code></pre>
<p>We also customized a function for generating volcano plots.</p>
<pre class="r"><code>geom_volcano &lt;- function(data = data, type = type, gene = gene_list)
{
  x = paste0(type, &quot;_mean&quot;)
  y = paste0(type, &quot;_p_value&quot;)
  title = str_extract(colnames(data), sprintf(&quot;^%s_.+&quot;, type)) %&gt;% unique() %&gt;% str_extract(., &quot;(?&lt;=[A-Za-z]_).+(?=_[0-9]$)&quot;) %&gt;% str_replace_all(., &quot;_&quot;, &quot; &quot;) %&gt;% na.omit()
  data &lt;- mutate_at(data, vars(y), funs(-log10(.)))
  x_limits = c(-6, 6)
  y_limits = c(0, 6)
  x_breaks = seq(min(x_limits), max(x_limits), 2)
  y_breaks = seq(min(y_limits), max(y_limits), 1)
  point_colour = setNames(c(brewer.pal(11, &quot;RdBu&quot;)[2], &quot;gray50&quot;, brewer.pal(11, &quot;RdBu&quot;)[10]),
                          c(&quot;up&quot;, &quot;ns&quot;, &quot;down&quot;))
  down_regulated_number = data %&gt;% filter(get(x) &lt;= -1, get(y) &gt; -log10(0.05)) %&gt;%  nrow(.)
  up_regulated_number = data %&gt;% filter(get(x) &gt;= 1, get(y) &gt; -log10(0.05)) %&gt;%  nrow(.)

  ggplot(data, aes_string(x, y)) +
    geom_point(aes_string(color = type), size = 2) +
    geom_vline(xintercept = c(-1, 1),
               linetype = &quot;dashed&quot;,
               color = &quot;gray50&quot;,
               size = 0.25) +
    geom_hline(yintercept = -log10(0.05),
               linetype =  &quot;dashed&quot;,
               color = &quot;gray50&quot;,
               size = 0.25) +
    geom_text_repel(data = . %&gt;% filter(Gene_names %in% gene,
                                        get(type) == &quot;down&quot; | get(type) == &quot;up&quot;),
                    aes(label = Gene_names),
                    size = 4,
                    segment.size = 0.25,
                    nudge_y = 0.5
                    ) +
    annotate(&quot;text&quot;,
             x = min(x_limits),
             y = max(y_limits),
             label = paste(&quot;Downregulated gene: &quot;, down_regulated_number),
             hjust = 0,
             size = 4) +
    annotate(&quot;text&quot;,
             x = max(x_limits),
             y = max(y_limits),
             label = paste(&quot;Upregulated gene: &quot;, up_regulated_number),
             hjust = 1,
             size = 4) +
    labs(title = title, x = &quot;Log2 Fold Change&quot;, y = &quot;-Log10(p value)&quot;) +
    scale_x_continuous(limits = x_limits, breaks = x_breaks) +
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +
    scale_color_manual(values = point_colour, guide = FALSE) +
    theme_classic() +
    theme(
          axis.line.x = element_line(size = 0.25),
          axis.line.y = element_line(size = 0.25),
          axis.ticks.x  = element_line(size = 0.25),
          axis.ticks.y  = element_line(size = 0.25),
          axis.title = element_text(size = 10),
          axis.text = element_text(size = 8),
          plot.title = element_text(size = 12,
                               face = &quot;plain&quot;))
}</code></pre>
<p>The volcano plots were shown below.</p>
<pre class="r"><code>gene_list &lt;- c(&quot;Oas3&quot;, &quot;Isg15&quot;, &quot;Ifi204&quot;, &quot;Ifit1&quot;, &quot;Gbp2&quot;, &quot;Gbp7&quot;, &quot;Cmpk2&quot;, &quot;Ddx58&quot;, &quot;Gvin1&quot;, &quot;Selenbp1;Selenbp2&quot;, &quot;Rnf213&quot;, &quot;Lgals9&quot;, &quot;Dtx3l&quot;, &quot;Fth1&quot;, &quot;Il1rn&quot;, &quot;Mmp9&quot;, &quot;Mmp8&quot;, &quot;Lrg1&quot;, &quot;F5&quot;, &quot;Retnlg&quot;, &quot;Ltf&quot;, &quot;Il1f9;Il36g&quot;, &quot;Lcn2&quot;, &quot;Mcm2&quot;, &quot;Dnmt1&quot;,  &quot;Lig1&quot;, &quot;Btf3&quot;)

volcano_g &lt;- lapply(c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;b&quot;, &quot;c&quot;), function(x) geom_volcano(data = all_stat_volcano,
                                                                         type = x,
                                                                         gene = gene_list))

plot_grid(plotlist = volcano_g[c(1, 2, 4, 3, 5)], nrow = 2)</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/volcano-plot-list-1.svg" width="1440" style="display: block; margin: auto;" /></p>
<p>We are also interested in the pathways these proteins involved. Therefore, we filtered the proteins and annotated them as down or up. They were used to search the Reactome database respectively and retrieved the pathway data for visualization.</p>
<pre class="r"><code>## as of 16 Oct 2018
all_stat_pathway &lt;-
  all_stat %&gt;%
  as_tibble() %&gt;%
  dplyr::filter(Sig_diff == TRUE &amp; !(abs(c_mean) &gt;= 1 &amp; c_p_value &lt; 0.05)) %&gt;%
  dplyr::select(Gene_names, A_mean, A_p_value, C_mean, C_p_value, b_mean, b_p_value) %&gt;%
  mutate(`1000_pfu_PR8_BAL_vs_1000_pfu_PR8_Blood_direction` = ifelse(A_mean &lt; -1 &amp; A_p_value &lt; 0.05, &quot;down&quot;, ifelse(A_mean &gt; 1 &amp; A_p_value &lt; 0.05, &quot;up&quot;, &quot;ns&quot;)),
         `1000_pfu_PR8_Blood_vs_1000_pfu_PR8_BM_direction` = ifelse(C_mean &lt; -1 &amp; C_p_value &lt; 0.05, &quot;down&quot;, ifelse(C_mean &gt; 1 &amp; C_p_value &lt; 0.05, &quot;up&quot;, &quot;ns&quot;)),
         `1000_pfu_PR8_BM_vs_pbs_BM_direction` = ifelse(b_mean &lt; -1 &amp; b_p_value &lt; 0.05, &quot;down&quot;, ifelse(b_mean &gt; 1 &amp; b_p_value &lt; 0.05, &quot;up&quot;, &quot;ns&quot;)))

purrr::map(c(&quot;1000_pfu_PR8_BAL_vs_1000_pfu_PR8_Blood&quot;, &quot;1000_pfu_PR8_Blood_vs_1000_pfu_PR8_BM&quot;, &quot;1000_pfu_PR8_BM_vs_pbs_BM&quot;),
           function(x) {
             direction &lt;- sym(glue::glue(x, &quot;_direction&quot;))

             assign(glue::glue(x, &quot;_down&quot;),
                    all_stat_pathway %&gt;%
                      dplyr::filter(!!direction == &quot;down&quot;) %&gt;%
                      pull(Gene_names),
                    envir = .GlobalEnv)

             assign(glue::glue(x, &quot;_up&quot;),
                    all_stat_pathway %&gt;%
                      dplyr::filter(!!direction == &quot;up&quot;) %&gt;%
                      dplyr::pull(Gene_names),
                    envir = .GlobalEnv)
           }) %&gt;% rm(.)</code></pre>
<p>Because in blood tissues, many proteins related to ribisome were downregulated and they would interfere the final outputs. To address this, we separated them first and proceeded to visualization.</p>
<pre class="r"><code>pathway_file &lt;- glue::glue(path, &quot;/20181018-reactome-pathway-analysis.xlsx&quot;)

Comparison_name_conversion &lt;-
  setNames(c(&quot;1000_pfu_PR8_BAL_vs_1000_pfu_PR8_Blood&quot;,
             &quot;1000_pfu_PR8_Blood_vs_1000_pfu_PR8_BM&quot;,
             &quot;1000_pfu_PR8_BM_vs_pbs_BM&quot;),
           c(&quot;flu_bal_vs_flu_blood&quot;,
             &quot;flu_blood_vs_flu_bm&quot;,
             &quot;flu_bm_vs_pbs_bm&quot;))

Pathway_all &lt;-
  purrr::map((readxl::excel_sheets(pathway_file)),
    function(i){
      assign(glue::glue(&quot;pathway_&quot;, i),
             readxl::read_excel(pathway_file, sheet = i) %&gt;%
               dplyr::select(`Pathway name`, `#Entities found`, `Entities FDR`, `Submitted entities found`) %&gt;%
               magrittr::set_colnames(c(&quot;Pathway&quot;, &quot;Found&quot;, &quot;FDR&quot;, &quot;Submitted_found&quot;)) %&gt;%
               dplyr::filter(FDR &lt; 0.05 &amp; Found &gt; 2) %&gt;%
               mutate(Entries = str_split(Submitted_found, &quot;;&quot;),
                      Down = map(1:nrow(.), ~ get(glue::glue(Comparison_name_conversion[i], &quot;_down&quot;))),
                      Up = map(1:nrow(.), ~ get(glue::glue(Comparison_name_conversion[i], &quot;_up&quot;)))) %&gt;%
               mutate(Down_no = map2(.$Entries, .$Down, ~ intersect(.x, .y)) %&gt;% map(length) %&gt;% as.numeric(),
                      Up_no = map2(.$Entries, .$Up, ~ intersect(.x, .y)) %&gt;% map(length) %&gt;% as.numeric(),
                      Database_extra_no = Found - Down_no - Up_no,
                      Comparison = rep(i, nrow(.))),
             envir = .GlobalEnv)
      }
    ) %&gt;%
  purrr::reduce(bind_rows)

## There are lots of ribosome-related proteins in the blood compartments.
## To ease visualization, we separated the
## pathways into two groups.
## - pathways involves the ribosome proteins
## - pathways excludes the ribosome proteins
Pathway_all_Blood &lt;-
  Pathway_all %&gt;%
  dplyr::filter(grepl(&quot;^Rp&quot;, Submitted_found)) %&gt;%
  ##  dplyr::filter(!grepl(&quot;^Rp&quot;, Submitted_found)) %&gt;%
  dplyr::filter(!Pathway %in% c(&quot;Immune System&quot;)) %&gt;%
  mutate(p_y = setNames(1:length(.$Pathway %&gt;% unique), .$Pathway %&gt;% unique %&gt;% sort(decreasing = T))[Pathway] %&gt;% as.numeric(),
         c_x = setNames(1:length(.$Comparison %&gt;% unique), .$Comparison %&gt;% unique %&gt;% sort(decreasing = T))[Comparison] %&gt;% as.numeric()) %&gt;%
  mutate(radius = sqrt(Found/40))

Pathway_all_exclude_Blood &lt;-
  Pathway_all %&gt;%
  dplyr::filter(!grepl(&quot;^Rp&quot;, Submitted_found)) %&gt;%
  dplyr::filter(!Pathway %in% c(&quot;Immune System&quot;)) %&gt;%
  mutate(p_y = setNames(1:length(.$Pathway %&gt;% unique), .$Pathway %&gt;% unique %&gt;% sort(decreasing = T))[Pathway] %&gt;% as.numeric(),
         c_x = setNames(1:length(.$Comparison %&gt;% unique), .$Comparison %&gt;% unique %&gt;% sort(decreasing = T))[Comparison] %&gt;% as.numeric()) %&gt;%
  mutate(radius = sqrt(Found/40))</code></pre>
<p>We first checked the proteins without ribisome “contamination”.</p>
<pre class="r"><code>g_pathway_exclue_Blood &lt;-
  ggplot(data = Pathway_all_exclude_Blood) +
  geom_scatterpie(aes(x = c_x, y = p_y, r = radius), color = &quot;transparent&quot;, cols = c(&quot;Down_no&quot;, &quot;Up_no&quot;, &quot;Database_extra_no&quot;), data = Pathway_all_exclude_Blood) +
  scale_y_continuous(limits = c(-2, 36), breaks = seq(1, 35, 1), labels = unique(Pathway_all_exclude_Blood$Pathway) %&gt;% sort(decreasing = T))  +
  scale_x_continuous(labels = c(&quot;1000 pfu PR8 BM vs pbs BM&quot;,
                                &quot;1000 pfu PR8 Blood vs 1000 pfu PR8 BM&quot;,
                                &quot;1000 pfu PR8 BAL vs 1000 pfu PR8 Blood&quot;
                              ),
                   breaks = c(1, 2, 3)) +
  coord_equal()  +
  scale_fill_manual(values = c(&quot;#000000&quot;, &quot;#d7191c&quot;, &quot;#2b83ba&quot;)) +
  geom_scatterpie_legend(Pathway_all_exclude_Blood$radius,
                         x = 1,
                         y = -2,
                         labeller=function(x) x=c(3, 7, 11, 15)
                         ) +
  theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab(NULL) +
  xlab(NULL)

g_pathway_exclue_Blood</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/pathway-exclude-ribosomes-1.svg" width="960" style="display: block; margin: auto;" /></p>
<p>And then the proteins related to ribisomes were visualized.</p>
<pre class="r"><code>g_pathway_Blood &lt;-
  ggplot(data = Pathway_all_Blood) +
  geom_scatterpie(aes(x = c_x + 1, y = p_y, r = radius), color = &quot;transparent&quot;, cols = c(&quot;Down_no&quot;, &quot;Up_no&quot;, &quot;Database_extra_no&quot;), data = Pathway_all_Blood) +
  scale_y_continuous(limits = c(-2, 40), breaks = seq(1, 39, 1), labels = unique(Pathway_all_Blood$Pathway) %&gt;% sort(decreasing = T))  +
  scale_x_continuous(labels = c(&quot;&quot;,
                                &quot;1000 pfu PR8 Blood vs 1000 pfu PR8 BM&quot;,
                                &quot;&quot;
                                ),
                     limits = c(0.5, 3.5),
                     breaks = c(1, 2, 3)) +
  coord_equal()  +
  scale_fill_manual(values = c(&quot;#000000&quot;, &quot;#d7191c&quot;, &quot;#2b83ba&quot;)) +
  geom_scatterpie_legend(Pathway_all_Blood$radius,
                         x = 1,
                         y = -2,
                         labeller=function(x) x=c(3, 7, 11, 15)) +
  theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab(NULL) +
  xlab(NULL)

g_pathway_Blood</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/pathway-include-ribosomes-1.svg" width="960" style="display: block; margin: auto;" /></p>
<p>Finally we used the alluvival flow to show the protein abundance changes from PBS BM to 1000 pfu PR8 BM and then Blood and BAL.</p>
<pre class="r"><code>g_alluvial &lt;-
  ggplot(all_stat_pathway %&gt;%
         dplyr::select(1, 8:10) %&gt;%
         gather(key, value, 2:4) %&gt;%
         mutate(freq = 1,
                value = factor(value, levels = c(&quot;up&quot;, &quot;ns&quot;, &quot;down&quot;)),
                key = factor(key, levels = c(&quot;1000_pfu_PR8_BM_vs_pbs_BM_direction&quot;,
                                             &quot;1000_pfu_PR8_Blood_vs_1000_pfu_PR8_BM_direction&quot;,
                                             &quot;1000_pfu_PR8_BAL_vs_1000_pfu_PR8_Blood_direction&quot;))),
       aes(key, freq, stratum = value, alluvium = Gene_names, fill = value, label = Gene_names)) +
  geom_stratum(alpha = .5) +
  geom_flow() +
  geom_text(stat = &quot;alluvium&quot;, size = 3) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        plot.margin=margin(5,5,5,50,unit=&quot;pt&quot;)) +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c(&quot;1000 pfu PR8 BM vs PBS BM&quot;,
                              &quot;1000 pfu PR8 Blood vs 1000 pfu PR8 BM&quot;,
                              &quot;1000 pfu PR8 BAL vs 1000 pfu PR8 Blood&quot;))

g_alluvial</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/ggalluvial-1.svg" width="576" style="display: block; margin: auto;" /></p>
</div>
<div id="ibaq-intensity-ranking" class="section level3">
<h3>iBAQ intensity ranking</h3>
<p>The intensity data were extracted from iBAQ values and only the proteins identified in both experiments were used.</p>
<pre class="r"><code>## customise a function to convert `0` to `NA` that is compatible with our previous defined function.
is_zero &lt;- function(x) { ifelse(x == 0, TRUE, FALSE)}

data_nov_intensity &lt;-
  raw_data_nov %&gt;%
  dplyr::select(matches(&quot;Gene names|iBAQ\\s[A-Z]{1}\\sRep[0-9]+$&quot;)) %&gt;%
    magrittr::set_colnames(c(&quot;Gene_names&quot;,
                           &quot;A_1st_1000_PFU_PR8_BM_1&quot;,
                           &quot;B_1st_1000_PFU_PR8_Blood_1&quot;,
                           &quot;C_1st_1000_PFU_PR8_BAL_1&quot;,
                           &quot;C_1st_1000_PFU_PR8_BAL_2&quot;,
                           &quot;A_1st_1000_PFU_PR8_BM_2&quot;,
                           &quot;B_1st_1000_PFU_PR8_Blood_2&quot;,
                           &quot;B_1st_1000_PFU_PR8_Blood_3&quot;,
                           &quot;C_1st_1000_PFU_PR8_BAL_3&quot;,
                           &quot;A_1st_1000_PFU_PR8_BM_3&quot;)) %&gt;%
  dplyr::filter(!is.na(Gene_names)) %&gt;%
  distinct(Gene_names, .keep_all = TRUE) %&gt;%
  as.data.table()

## To make the iBAQ dataset compatible with our `filter_valid` function.
data_nov_intensity[is_zero(data_nov_intensity)] &lt;- NA

valid_list &lt;- c(&quot;tissue&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;)
for (i in valid_list) {
  data_nov_intensity[,
           sprintf(&quot;rep_%s_valid&quot;, i) := filter_valid(.SD),
           .SDcols = names(data_nov_intensity) %like% ifelse(i == &quot;tissue&quot;, &quot;^[ABC]_.+_[0-9]$&quot;, sprintf(&quot;_%s$&quot;, i))]
}

data_nov_intensity &lt;-
  data_nov_intensity %&gt;%
  as_tibble() %&gt;%
  dplyr::filter(rep_tissue_valid == TRUE) %&gt;%
  dplyr::select(-matches(&quot;valid$&quot;)) %&gt;%
  tidyr::gather(group, value, -Gene_names)

data_dec_intensity &lt;-
  raw_data_dec %&gt;%
  dplyr::select(matches(&quot;Gene names|iBAQ\\s[A-Z]{1}\\sRep[0-9]+$&quot;)) %&gt;%
  magrittr::set_colnames(c(
    &quot;Gene_names&quot;,
    &quot;F_2nd_PBS_BM_1&quot;,
    &quot;E_2nd_PBS_Blood_1&quot;,
    &quot;D_2nd_1000_PFU_PR8_BM_1&quot;,
    &quot;D_2nd_1000_PFU_PR8_BM_2&quot;,
    &quot;F_2nd_PBS_BM_2&quot;,
    &quot;E_2nd_PBS_Blood_2&quot;,
    &quot;E_2nd_PBS_Blood_3&quot;,
    &quot;D_2nd_1000_PFU_PR8_BM_3&quot;,
    &quot;F_2nd_PBS_BM_3&quot;
  )) %&gt;%
  dplyr::filter(!is.na(Gene_names)) %&gt;%
  distinct(Gene_names, .keep_all = TRUE) %&gt;%
  as.data.table()

## To make the iBAQ dataset compatible with our `filter_valid` function.
data_dec_intensity[is_zero(data_dec_intensity)] &lt;- NA

valid_list &lt;- c(&quot;tissue&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;)
for (i in valid_list) {
  data_dec_intensity[,
           sprintf(&quot;rep_%s_valid&quot;, i) := filter_valid(.SD),
           .SDcols = names(data_dec_intensity) %like% ifelse(i == &quot;tissue&quot;, &quot;^[DEF]_.+_[0-9]$&quot;, sprintf(&quot;_%s$&quot;, i))]
}

data_dec_intensity &lt;-
  data_dec_intensity %&gt;%
  as_tibble() %&gt;%
  dplyr::filter(rep_tissue_valid == TRUE) %&gt;%
  dplyr::select(-matches(&quot;valid$&quot;)) %&gt;%
  tidyr::gather(group, value, -Gene_names)

data_intensity &lt;-
  bind_rows(data_nov_intensity, data_dec_intensity) %&gt;%
  mutate(gene_count = 1) %&gt;%
  group_by(Gene_names) %&gt;%
  mutate(gene = sum(gene_count)) %&gt;%
  dplyr::filter(gene == 18) %&gt;%
  dplyr::select(-gene_count, -gene) %&gt;%
  group_by(group) %&gt;%
  mutate(ranking = dplyr::dense_rank(-value),
         percent = value / sum(value)) %&gt;%
  arrange(-percent, group) %&gt;%
  mutate(percent_cum = cumsum(percent))</code></pre>
<pre class="r"><code>## Customise a function to draw ranking plots and insert a small plot which contains proteins accounting for 75% of total abundance.
geom_ranking &lt;- function(df) {
  ranking_marker &lt;- df %&gt;% dplyr::slice(base::which.min(abs(percent_cum - 0.75))) %&gt;% pull(ranking)

  df_annotation &lt;- df %&gt;% dplyr::filter(ranking &lt;= ranking_marker)

  title &lt;- df$group %&gt;% unique() %&gt;% toString() %&gt;% stringr::str_replace_all(&quot;_&quot;, &quot; &quot;) %&gt;% stringr::str_replace_all(&quot;^[A-F]\\s&quot;, &quot;&quot;)

  p &lt;-
    ggplot(df, aes(ranking, percent_cum)) +
    geom_line() +
    geom_point() +
    labs(title = title,
         y = NULL,
         x = NULL) +
    scale_x_continuous(breaks = seq(0, 2000, 200),
                       labels = seq(0, 2000, 200),
                       limits = c(0, 2000)) +
    scale_y_continuous(breaks = seq(0, 1, 0.1)) +
    theme(axis.title = element_text(size = 10),
          axis.text = element_text(size = 8),
          plot.title = element_text(size = 12,
                                    face = &quot;plain&quot;,
                                    hjust = 0.5))

  x_max &lt;- df_annotation %&gt;% pull(ranking) %&gt;% max()
  y_max &lt;- df_annotation %&gt;% dplyr::filter(ranking == x_max) %&gt;% pull(percent_cum)

  p_annotation &lt;-
    ggplotGrob(
      ggplot(df_annotation, aes(ranking, percent_cum)) +
        geom_line() +
        geom_point() +
        geom_segment(aes(x = 0,
                         xend = x_max,
                         y = y_max,
                         yend = y_max),
                     linetype = &quot;dashed&quot;) +
        geom_segment(aes(x = x_max,
                         xend = x_max,
                         y = 0,
                         yend = y_max,),
                     linetype = &quot;dashed&quot;) +
        scale_x_continuous(limits = c(0, 80),
                           breaks = c(seq(0, 40, 10), x_max, 80),
                           labels = c(seq(0, 40, 10), x_max, 80),
                         expand = expand_scale(mult = c(0, 0.01),
                                               add = c(0, 0))) +
        scale_y_continuous(breaks = seq(0, 0.80, 0.1),
                           expand = expand_scale(mult = c(0, 0.05),
                                         add = c(0, 0))) +
        expand_limits(c(0, 0)) +
        labs(y = NULL,
             x = NULL) +
        theme_bw() +
        theme(axis.title = element_text(size = 10),
              axis.text = element_text(size = 8))
    )

  p + annotation_custom(
    grob = p_annotation,
    xmin = 500,
    xmax = 1900,
    ymin = 0.1,
    ymax = 0.85
  )
}</code></pre>
<pre class="r"><code>ranking_plot &lt;-
  purrr::map(
    data_intensity$group %&gt;% unique() %&gt;% stringr::str_sort(),
    ~ geom_ranking(dplyr::filter(data_intensity, group == .x))
)

cowplot::plot_grid(plotlist = ranking_plot,
                   ncol = 3,
                   scale = 0.9) + ## reduce this for a bit more space
  cowplot::draw_label(&quot;Ranking&quot;,
                      x = 0.5,
                      y = 0,
                      vjust = -0.5,
                      angle = 0) +
  cowplot::draw_label(&quot;Cumulative proportion&quot;,
                      x = 0,
                      y = 0.5,
                      vjust = 1.5,
                      angle = 90)</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/visualised-intensity-ranking-1.svg" width="1536" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="analysis-of-bal-neutrophil-proteome-changes-following-different-doses-of-influenza-infection-or-bacterial-infection" class="section level2">
<h2>Analysis of BAL neutrophil proteome changes following different doses of influenza infection or bacterial infection</h2>
<div id="raw-data-cleaning-1" class="section level3">
<h3>Raw data cleaning</h3>
<p>The labelling details are below:</p>
<table>
<caption><strong>Experiment 3 Biological replicate 1</strong></caption>
<thead>
<tr class="header">
<th align="left">Labelling</th>
<th align="left">Sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Light (L)</td>
<td align="left">100 pfu PR8 BAL neutrophil</td>
</tr>
<tr class="even">
<td align="left">Medium (M)</td>
<td align="left">1000 pfu PR8 BAL neutrophil</td>
</tr>
<tr class="odd">
<td align="left">Heavy (H)</td>
<td align="left">10<sup>6</sup> CFU <em>Pseudomonas Aeruginosa</em> BAL neutrophil</td>
</tr>
</tbody>
</table>
<table>
<caption><strong>Experiment 3 Biological replicate 2</strong></caption>
<thead>
<tr class="header">
<th align="left">Labelling</th>
<th align="left">Sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Light (L)</td>
<td align="left">1000 PFU PR8 BAL neutrophil</td>
</tr>
<tr class="even">
<td align="left">Medium (M)</td>
<td align="left">10<sup>6</sup> CFU <em>Pseudomonas Aeruginosa</em> BAL neutrophil</td>
</tr>
<tr class="odd">
<td align="left">Heavy (H)</td>
<td align="left">100 pfu PR8 BAL neutrophil</td>
</tr>
</tbody>
</table>
<table>
<caption><strong>Experiment 3 Biological replicate 3</strong></caption>
<thead>
<tr class="header">
<th align="left">Labelling</th>
<th align="left">Sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Light (L)</td>
<td align="left">10<sup>6</sup> CFU <em>Pseudomonas Aeruginosa</em> BAL neutrophil</td>
</tr>
<tr class="even">
<td align="left">Medium (M)</td>
<td align="left">100 PFU PR8 BAL neutrophil</td>
</tr>
<tr class="odd">
<td align="left">Heavy (H)</td>
<td align="left">1000 PFU PR8 BAL neutrophil</td>
</tr>
</tbody>
</table>
<p>We first tried data cleaning for this dataset. The proteins with different abundance were also filtered out.</p>
<pre class="r"><code>data_201712 &lt;-
  read_tsv(glue::glue(path, &quot;/20180206-Proteomics-201801-Requant.txt&quot;)) %&gt;%
  filter(is.na(.$`Only identified by site`) &amp; is.na(.$Reverse) &amp;  is.na(.$`Potential contaminant`) &amp; `Razor + unique peptides` &gt;= 1) %&gt;%
  dplyr::select(matches(&quot;Gene names|normalized Rep&quot;)) %&gt;%
  magrittr::set_colnames(c(&quot;Gene_names&quot;,
                           &quot;A_1000_PFU_PR8_vs_100_PFU_PR8_1&quot;,
                           &quot;B_10^6_CFU_Pseudomonas_vs_1000_PFU_PR8_2&quot;,
                           &quot;C_10^6_CFU_Pseudomonas_vs_100_PFU_PR8_3_invert&quot;,
                           &quot;C_10^6_CFU_Pseudomonas_vs_100_PFU_PR8_1&quot;,
                           &quot;A_1000_PFU_PR8_vs_100_PFU_PR8_2_invert&quot;,
                           &quot;B_10^6_CFU_Pseudomonas_vs_1000_PFU_PR8_3_invert&quot;,
                           &quot;B_10^6_CFU_Pseudomonas_vs_1000_PFU_PR8_1&quot;,
                           &quot;C_10^6_CFU_Pseudomonas_vs_100_PFU_PR8_2_invert&quot;,
                           &quot;A_1000_PFU_PR8_vs_100_PFU_PR8_3&quot;)) %&gt;%
  mutate_at(vars(contains(&quot;invert&quot;)), funs(1/.)) %&gt;%
  magrittr::set_colnames(sapply(colnames(.), function(x) str_replace(x, &quot;_invert&quot;, &quot;&quot;))) %&gt;%
  mutate_at(vars(-Gene_names), funs(log2(.))) %&gt;%
  as.data.table()

for (i in valid_list) {
  data_201712[,
              sprintf(&quot;rep_%s_valid&quot;, i) := filter_valid(.SD),
              .SDcols = names(data_201712) %like% ifelse(i == &quot;tissue&quot;,
                                                         &quot;^[ABC]_.+_[0-3]$&quot;,
                                                         sprintf(&quot;_%s$&quot;, i))]
}

data_201712_stat &lt;-
  data_201712 %&gt;%
  filter(rep_tissue_valid == TRUE) %&gt;%
  dplyr::select(-matches(&quot;valid$&quot;)) %&gt;%
  as.data.table()

for (i in c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;)) {
  data_201712_stat[,
                   c(sprintf(&quot;%s_p_value&quot;, i),
                     sprintf(&quot;%s_mean&quot;, i))   := list(apply(.SD, 1, function(x) t.test(x)$p.value),
                                                      apply(.SD, 1, function(x) mean(x))),
                   .SDcols = names(data_201712_stat) %like% sprintf(&quot;^%s.+[0-9]$&quot;, i)]
}

data_201712_stat &lt;-
  data_201712_stat %&gt;%
  as_data_frame() %&gt;%
  dplyr::select(Gene_names, everything()) %&gt;%
  mutate(sig = (A_p_value &lt;0.05 &amp; abs(A_mean) &gt; 1)|(B_p_value &lt; 0.05&amp;abs(B_mean) &gt; 1) | (C_p_value &lt; 0.05 &amp; abs(C_mean) &gt; 1))</code></pre>
</div>
<div id="overall-impression-of-datasets" class="section level3">
<h3>Overall impression of datasets</h3>
<p>Then we generated a PCA analysis to look at the protein abundance pattern.</p>
<pre class="r"><code>set.seed(2018)
pca_matrix_201712 &lt;-
  data_201712_stat %&gt;%
  as_data_frame() %&gt;%
  dplyr::select(matches(&quot;_1|_2|_3&quot;)) %&gt;%
  as.matrix %&gt;%
  princomp(., cor = T)

pca_matrix_pov_201712 &lt;- pca_matrix_201712$sdev^2/sum(pca_matrix_201712$sdev^2)

pca_df_201712 &lt;- pca_matrix_201712$loadings[] %&gt;%
  as.data.frame %&gt;%
  mutate(Sample = row.names(.)) %&gt;%
  mutate(Categories = str_extract(Sample, &quot;(?&lt;=[A-Z]{1}_).+(?=_[0-9]{1})&quot;)) %&gt;%
  mutate(Batch = str_extract(Sample, &quot;[0-9]{1}$&quot;))

ggplot(pca_df_201712, aes(Comp.1, Comp.2, color = Categories)) +
  geom_point(size = 4) +
  geom_text_repel(aes(label = Batch)) +
  labs(x = sprintf(&quot;PC1: %.3f %% Variance&quot;, pca_matrix_pov_201712[&quot;Comp.1&quot;]*100),
       y = sprintf(&quot;PC2: %.3f %% Variance&quot;, pca_matrix_pov_201712[&quot;Comp.2&quot;]*100)) +
  scale_color_manual(values = brewer.pal(6, &quot;RdBu&quot;)[c(1,3, 5)]) +
  theme_classic() +
  theme(aspect.ratio = 1,
        panel.border = element_rect(fill = &quot;transparent&quot;,
                                    color = &quot;black&quot;))</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/PCA-plot-for-the-proteome-involved-bacterial-infection-1.svg" width="768" style="display: block; margin: auto;" />
### Analysis of proteins with significant abundance changes</p>
<p>Lastly, a heatmap for all proteins with different abundance detected in at least one group was visualized.</p>
<pre class="r"><code>data_201712_heatmap_ha_df &lt;-
  data.frame(type = colnames(data_201712 %&gt;% dplyr::select(-matches(&quot;valid|Gene&quot;)))) %&gt;%
  mutate(Comparision = str_extract(type, &quot;(?&lt;=[ABC]_).+(?=_[0-9]{1}$)&quot;)) %&gt;%
  dplyr::select(-type)

data_201712_heatmap_ha &lt;-
  columnAnnotation(
    df = data_201712_heatmap_ha_df,
    col = list(
      Comparision = setNames(
        brewer.pal(6, &quot;RdBu&quot;)[c(1,3, 5)],
        sort(data_201712_heatmap_ha_df %&gt;% pull(Comparision) %&gt;% unique))),
    annotation_legend_param = list(
      Comparision = list(
        nrow = 3,
        title = &quot;Comparison&quot;,
        title_gp = gpar(fontsize = 8),
        labels_gp = gpar(fontsize = 6)
      )
    )
  )</code></pre>
<p>The cluster number was first determined by <strong><em>fviz_nbclust</em></strong> function.</p>
<pre class="r"><code>data_201712_sig_heatmap_df &lt;-
  data_201712_stat %&gt;%
  dplyr::filter(sig == TRUE) %&gt;%
  dplyr::select(matches(&quot;Gene|_vs_&quot;)) %&gt;%
  `colnames&lt;-`(sapply(colnames(.), function(x) str_replace(x, &quot;^[A-Za-z]{1}_&quot;, &quot;&quot;))) %&gt;%
  `colnames&lt;-`(sapply(colnames(.), function(x) str_replace_all(x, &quot;_&quot;, &quot; &quot;)))

factoextra::fviz_nbclust(data_201712_sig_heatmap_df %&gt;% dplyr::select(-matches(&quot;Gene&quot;)),
  kmeans,
  method = &quot;wss&quot;
)</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/determine-the-clusters-for-data_201712-1.svg" width="576" style="display: block; margin: auto;" /></p>
<p>Based on the plot, we can 3 clusters are the best option to visualize the dataset.</p>
<pre class="r"><code>data_201712_sig_heatmap_df &lt;-
  data_201712_sig_heatmap_df %&gt;%
  mutate(cluster = kmeans(data_201712_sig_heatmap_df %&gt;% dplyr::select(-matches(&quot;Gene&quot;)), 3)$cluster)

data_201712_sig_stat_heatmap_matrix &lt;-
  data_201712_sig_heatmap_df %&gt;%
  as.matrix() %&gt;%
  `rownames&lt;-`(.[, &quot;Gene names&quot;]) %&gt;%
  .[, !colnames(.) %in% c(&quot;Gene names&quot;)] %&gt;%
  `class&lt;-`(&quot;numeric&quot;)

data_201712_sig_stat_heatmap_ha_row &lt;-
  rowAnnotation(
    df = data_201712_sig_heatmap_df %&gt;% dplyr::select(cluster) %&gt;% as.data.frame(),
    col = list(cluster = setNames(
      brewer.pal(3, &quot;BrBG&quot;),
      data_201712_sig_heatmap_df %&gt;% pull(cluster) %&gt;% unique() %&gt;% sort(.)
    )
    ),
    width = unit(0.2, &quot;in&quot;),
    annotation_legend_param = list(
      nrow = 1,
      title = &quot;Cluster&quot;,
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 8),
      legend_width = unit(1, &quot;in&quot;)
    )
  )

set.seed(123)
data_201712_sig_stat_heatmap &lt;-
  Heatmap(data_201712_sig_stat_heatmap_matrix[, !colnames(data_201712_sig_stat_heatmap_matrix) %in% c(&quot;cluster&quot;)],
    top_annotation = data_201712_heatmap_ha,
    heatmap_legend_param = list(
      title = &quot;Log2 Fold Change&quot;,
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 8),
      legend_direction = &quot;horizontal&quot;,
      legend_width = unit(1.5, &quot;inch&quot;)
    ),
    show_column_names = FALSE,
    show_row_dend = FALSE,
    combined_name_fun = NULL,
    row_names_gp = gpar(fontsize = 8),
    split = data_201712_sig_stat_heatmap_matrix[, &quot;cluster&quot;],
    gap = unit(1.5, &quot;mm&quot;)
  )


draw(data_201712_sig_stat_heatmap_ha_row + data_201712_sig_stat_heatmap, heatmap_legend_side = &quot;bottom&quot;, annotation_legend_side = &quot;bottom&quot;)

for (an in colnames(data_201712_heatmap_ha_df)) {
  decorate_annotation(an, {
    ## annotation names on the left
    grid.text(an,
      unit(1, &quot;npc&quot;) + unit(2, &quot;mm&quot;),
      0.6,
      default.units = &quot;npc&quot;,
      just = &quot;left&quot;,
      gp = gpar(fontsize = 8)
    )
  })
}</code></pre>
<p><img src="/post/2019-01-25-neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection_files/figure-html/heatmap-for-the-proteome-involved-bacterial-infection-1.svg" width="864" style="display: block; margin: auto;" /></p>
</div>
</div>
