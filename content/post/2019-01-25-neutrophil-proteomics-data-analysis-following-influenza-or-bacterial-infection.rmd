---
title: "Semi quantitative proteomics enables mapping of global neutrophil dynamics following influenza virus infection"
date: "2019-01-25"
author: Chuanxin Liu
categories:
- Research
- Coding
tags:
- research
- publication
image: "https://8heddw.ch.files.1drv.com/y4mSLrpvgdAbg0tTkx3RhzfRqpLs7L6xDT3U5NO7USxOLxnX0XjJFEg5j90FI-Xw9qovOyAX-e92EKz2hUT8QWsdLX2vB5J0KsxqxeWhgZQvT2O0LKq9YezyECWyCl5mZcAF_x2V5YpMXPUsK0VmA4wvUZui9_bQxt8RlEtQx-XqixRUR6kcIWCULI5HnhGhgQs?width=1920&height=1080&cropmode=none"
output:
  blogdown::html_page:
    dev: "svg" ## set the default output device to svg
    toc: true
---

## Source code and dataset availability

Source code is hosted on [github](https://github.com/codetrainee/Neutrophil-systems-biology)

## Prerequisite

We first loaded libraries required for analysis.

```{r load-libraries, warning=FALSE}
pacman::p_load(tidyverse,
               magrittr,
               ggrepel,
               ggthemes,
               eulerr,
               ComplexHeatmap,
               gridExtra,
               factoextra,
               data.table,
               cowplot,
               egg,
               gridExtra,
               RColorBrewer,
               ggalluvial,
               glue,
               customLayout,
               org.Mm.eg.db,
               AnnotationDbi,
               ggthemr,
               scatterpie
               )
```

The theme for figures generated by ggplot2 was set to `dust` style from [ggthemr](https://github.com/cttobin/ggthemr) packages.

```{r set-the-global-theme-to-ggthemr-style}
ggthemr("dust")
```

To have a tidy output, the figures were centered and message and warning was suppressed by defaults.

```{r global-options-for-knitr}
knitr::opts_chunk$set(fig.align='center',
                      message=FALSE,
                      warning=FALSE)
```

All data were stored under the below folders and raw datasets can be found in the [Source code and dataset availability](##Source-code-and-dataset-availability)

```{r set-global-variables}
path <- "data/Neutrophil-proteomics-data-analysis-following-influenza-or-bacterial-infection/"
```

In the raw datasets, there are plenty of `NA` values requiring to be cleaned before downstream analyses and we then customised a function for removing these unwanted pick-ups.

To survive the filter step, a pick-up protein should meet following requirements:

- should be detected in at least one comparison group.
- should be picked up in three independent replicates.

```{r customised-a-filter-function}
filter_valid <-
  function(df) {
    matrix <- apply(df, MARGIN = 2, function(x) !is.na(x))

    log_test_valid <- (apply(matrix, MARGIN = 1, prod) == 0) == ((apply(matrix, MARGIN = 1, sum) == 0))

    log_test_na <- !((apply(matrix, MARGIN = 1, prod) == 0) & ((apply(matrix, MARGIN = 1, sum) == 0)))

    log_test <- (log_test_valid + log_test_na) == 2

    return(log_test)
  }
```

## Analysis of neutrophil proteome at homeostasis or following a lethal IAV infection

The analysis pipeline included 3 experiments. The first two were combined together to identify neutrophil-derived markers in an 1000 pfu PR8 influenza infection compared to PBS treated control. The third experiment compared the neutrophil proteome in different doses of influenza infection and bacterial infection.

### Raw data cleaning

We first loaded dataset from two experiments and removed the contamination respectively.

```{r load-raw-data-for-first-exp, warning=FALSE, results='hide'}
raw_data_nov <-
  read_tsv(glue(path, "20170428-Proteomics-201611-Requant.txt")) %>%
  ## Remove the contamination and duplicates
  filter(is.na(.$`Only identified by site`) & is.na(.$Reverse) & is.na(.$`Potential contaminant`) & `Razor + unique peptides` >= 1)

raw_data_dec <-
  read_tsv(glue(path, "20170428-Proteomics-201612-Requant.txt")) %>%
  ## Remove the contamination and duplicates
  filter(is.na(.$`Only identified by site`) & is.na(.$Reverse) & is.na(.$`Potential contaminant`) & `Razor + unique peptides` >= 1)
```

The dataset was annotated by labelling samples. Missing values were filtered out using customised functions. The label details are below:

| Labelling  | Sample                        |
|------------|-------------------------------|
| Light (L)  | 1000 PFU PR8 BM neutrophil    |
| Medium (M) | 1000 PFU PR8 Blood neutrophil |
| Heavy (H)  | 1000 PFU PR8 BAL neutrophil   |

Table: **Experiment 1 Biological replicate 1**

| Labelling  | Sample                        |
|------------|-------------------------------|
| Light (L)  | 1000 PFU PR8 BAL neutrophil   |
| Medium (M) | 1000 PFU PR8 BM neutrophil    |
| Heavy (H)  | 1000 PFU PR8 Blood neutrophil |

Table: **Experiment 1 Biological replicate 2**

| Labelling  | Sample                        |
|------------|-------------------------------|
| Light (L)  | 1000 PFU PR8 Blood neutrophil |
| Medium (M) | 1000 PFU PR8 BAL neutrophil   |
| Heavy (H)  | 1000 PFU PR8 BM neutrophil    |

Table: **Experiment 1 Biological replicate 3**

| Labelling  | Sample                     |
|------------|----------------------------|
| Light (L)  | PBS BM neutrophil          |
| Medium (M) | PBS Blood neutrophil       |
| Heavy (H)  | 1000 PFU PR8 BM neutrophil |

Table: **Experiment 2 Biological replicate 1**

| Labelling  | Sample                     |
|------------|----------------------------|
| Light (L)  | 1000 PFU PR8 BM neutrophil |
| Medium (M) | PBS BM neutrophil          |
| Heavy (H)  | PBS Blood neutrophil       |

Table: **Experiment 2 Biological replicate 2**

| Labelling  | Sample                  |
|------------|-------------------------|
| Light (L)  | PBS Blood neutrophil    |
| Medium (M) | 1000 PFU PR8 neutrophil |
| Heavy (H)  | PBS BM neutrophil       |

Table: **Experiment 2 Biological replicate 3**

```{r data-precleaning, warings=FALSE}
data_nov <-
  raw_data_nov %>%
  ## select the required columns
  dplyr::select(matches("Gene names|normalized Rep")) %>%
  magrittr::set_colnames(c(
    "Gene_names",
    "C_1000_PFU_PR8_Blood_vs_1000_PFU_PR8_BM_1",
    "B_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_BM_2_invert",
    "A_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_Blood_3",
    "B_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_BM_1",
    "A_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_Blood_2_invert",
    "C_1000_PFU_PR8_Blood_vs_1000_PFU_PR8_BM_3_invert",
    "A_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_Blood_1",
    "C_1000_PFU_PR8_Blood_vs_1000_PFU_PR8_BM_2",
    "B_1000_PFU_PR8_BAL_vs_1000_PFU_PR8_BM_3_invert"
  )) %>%
  dplyr::select(order(colnames(.))) %>%
  ## Remove the gene names were not identified.
  filter(!is.na(Gene_names)) %>%
  ## Some duplicate gene names were removed.
  distinct(Gene_names, .keep_all = TRUE) %>%
  ## In the dimethyl labelling, the comparision ratio sometimes were inverted and required inversion.
  mutate_at(vars(contains("invert")), funs(1 / .)) %>%
  ## Remove introduced the `invert` in the column names.
  magrittr::set_colnames(sapply(colnames(.), function(x) str_replace(x, "_invert", ""))) %>%
  ## log transformation
  mutate_at(vars(-Gene_names), funs(log2(.))) %>%
  ## converted to data.table for filter.
  as.data.table()

valid_list <- c("tissue", "1", "2", "3")
for (i in valid_list) {
  data_nov[,
           sprintf("rep_%s_valid", i) := filter_valid(.SD),
           .SDcols = names(data_nov) %like% ifelse(i == "tissue", "^[ABCabc]_.+_[0-9]$", sprintf("_%s$", i))]
}

data_nov_stat <-
  data_nov %>%
  filter(rep_tissue_valid == TRUE) %>%
  dplyr::select(-matches("valid$"))

## Annotations were similar to the preparation step for the above experiment.
data_dec <-
  raw_data_dec %>%
  dplyr::select(matches("Gene names|normalized Rep")) %>%
  magrittr::set_colnames(c(
    "Gene_names",
    "c_PBS_Blood_vs_PBS_BM_1",
    "b_1000_PFU_PR8_BM_vs_PBS_BM_2_invert",
    "a_1000_PFU_PR8_BM_vs_PBS_Blood_3",
    "b_1000_PFU_PR8_BM_vs_PBS_BM_1",
    "a_1000_PFU_PR8_BM_vs_PBS_Blood_2_invert",
    "c_PBS_Blood_vs_PBS_BM_3_invert",
    "a_1000_PFU_PR8_BM_vs_PBS_Blood_1",
    "c_PBS_Blood_vs_PBS_BM_2",
    "b_1000_PFU_PR8_BM_vs_PBS_BM_3_invert"
  )) %>%
  dplyr::select(order(colnames(.))) %>%
  filter(!is.na(Gene_names)) %>%
  distinct(Gene_names, .keep_all = TRUE) %>%
  mutate_at(vars(contains("invert")), funs(1 / .)) %>%
  magrittr::set_colnames(sapply(colnames(.), function(x) str_replace(x, "_invert", ""))) %>%
  mutate_at(vars(-Gene_names), funs(log2(.))) %>%
  as.data.table()

for (i in valid_list) {
  data_dec[,
           sprintf("rep_%s_valid", i) := filter_valid(.SD),
           .SDcols = names(data_dec) %like% ifelse(i == "tissue", "^[ABCabc]_.+_[0-9]$", sprintf("_%s$", i))]
}

data_dec_stat <-
  data_dec %>%
  filter(rep_tissue_valid == TRUE) %>%
  dplyr::select(-matches("valid$"))
```

Proteins detected in both experiments were kept and statistics tests were applied. Protein with a fold change greater than 2 and p value less than 0.05 in at least one comparison group was considered significant in protein abundance change.

```{r combine-two-exp-and-apply-statistics-test}
all_stat <-
  ## combine two experiments
  inner_join(data_nov_stat, data_dec_stat) %>%
  ## Remove the comparison between 1000 PFU PR8 BM and PBS Blood. The ideal comparison should be 1000 PFU PR8 Blood
  ## vs PBS Blood. Due to the technique limitations, we can't achieve the goal.
  dplyr::select(-matches("1000_PFU_PR8_BM_vs_PBS_Blood")) %>%
  as.data.table()

sig_list <- c("A", "B", "C", "b", "c")

for (i in sig_list) {
  all_stat[,
           c(sprintf("%s_p_value", i),
             sprintf("%s_mean", i))   := list(apply(.SD, 1, function(x) t.test(x)$p.value),
                                              apply(.SD, 1, function(x) mean(x))),
           .SDcols = names(all_stat) %like% sprintf("^%s.+[0-9]$", i)]
}

all_stat <-
  all_stat %>%
  ## The proteins with fold change > 2 and p value < 0.05 were selected.
  mutate(Sig_diff = (A_p_value < 0.05 & abs(A_mean) > 1) | (B_p_value < 0.05 & abs(B_mean) > 1) | (C_p_value < 0.05 & abs(C_mean) > 1) | (b_p_value < 0.05 & abs(b_mean) > 1) | (c_p_value < 0.05 & abs(c_mean) > 1))
```

### Visualization of pick-up proteins in independent experiments and biological replicates

Before moving on, we checked all proteins identified in all replicates and visualized them via Venn Diagram.

```{r Venn-Diagram, fig.dim=c(8, 8)}
## Visualise the pick-up difference between independent replicates and experiments.
## for the first experiment
data_nov_replicate <-
  data_nov %>%
  filter(rep_1_valid + rep_2_valid + rep_3_valid > 0) %>%
  dplyr::select(matches("^rep_[0-9]{1}_valid$")) %>%
  ## Venn diagram was drawn with [eulerr](https://github.com/jolars/eulerr)
  euler(.) %>%
  plot(.,
       main = "Experiment 1",
       quantities = TRUE,
       fill = c("#f1a340", "#f7f7f7", "#998ec3"),
       legend = list(side = "bottom")
  )

## for the second experiment
data_dec_replicate <-
  data_dec %>%
  filter(rep_1_valid + rep_2_valid + rep_3_valid > 0) %>%
  dplyr::select(matches("^rep_[0-9]{1}_valid$")) %>%
  euler(.) %>%
  plot(.,
       main = "Experiment 2",
       quantities = TRUE,
       fill = c("#d8b365", "#f5f5f5", "#5ab4ac"),
       legend = list(side = "bottom")
  )

## combine two experiment
all_replicate <-
  full_join(
    data_nov %>%
      mutate(Nov = (rep_1_valid * rep_2_valid * rep_3_valid == 1)) %>%
      dplyr::select(Gene_names, Nov),
    data_dec %>%
      mutate(Dec = (rep_1_valid * rep_2_valid * rep_3_valid == 1)) %>%
      dplyr::select(Gene_names, Dec)
  ) %>%
  dplyr::select(-Gene_names)
all_replicate[is.na(all_replicate)] <- FALSE

all_replicate <-
  all_replicate %>%
  euler(.) %>%
  plot(.,
       main = "Two experiments combined",
       quantities = TRUE,
       fill = c("#fc8d59", "#91bfdb"),
       legend = list(side = "bottom")
  )

## customise the layout of venn diagrams using [customLayout](https://github.com/zzawadz/customLayout)
Venn_lay <- lay_new(
  matrix(1:2, nc = 2),
  widths = c(1, 1)
)

Venn_lay2 <- lay_new(matrix(1))

Venn_cl <- lay_bind_row(Venn_lay, Venn_lay2, heights = c(1.2, 1))

lay_grid(list(data_nov_replicate, data_dec_replicate, all_replicate), Venn_cl)
```

### Overall impression of proteome dataset

To examine their protein abundance pattern similarity, PCA analysis was conducted.

```{r PCA-analysis, fig.keep="all", fig.dim=c(8, 8)}
set.seed(123)
all_stat_pca <-
  all_stat %>%
  dplyr::select(matches("_vs_")) %>%
  as.matrix() %>%
  prcomp(.)

## PCA results QC
fviz_eig(all_stat_pca)

## caculate the variances explained by each principle component
all_stat_pca_pov <- all_stat_pca$sdev^2 / sum(all_stat_pca$sdev^2)

## extract the dataframe from PCA analysis
all_stat_pca_df <- all_stat_pca$rotation %>%
  as.data.frame() %>%
  mutate(Sample = row.names(.),
         Comparison = str_replace_all(str_extract(Sample, "(?<=[A-Za-z]{1}_).+(?=_[0-9]{1})"), "_", " "),          batch = str_extract(Sample, "[0-9]{1}$"))

## visualise the PCA using ggplot2
ggplot(all_stat_pca_df, aes(PC1, PC2, colour = Comparison)) +
  geom_point(size = 4) +
  labs(
    x = sprintf("PC1: %.2f %% Variance", all_stat_pca_pov[[1]] * 100),
    y = sprintf("PC2: %.2f %% Variance", all_stat_pca_pov[[2]] * 100)
  ) +
  scale_colour_manual(values = brewer.pal(6, "RdBu")[1:5]) +
  theme_classic() +
  theme(aspect.ratio = 1,
        legend.position = "bottom",
        panel.border = element_rect(fill = "transparent"),
        legend.direction = "vertical"
        )
```

Another way to visualize all protein abundance pattern is the heatmap.

```{r heatmap-for-all-proteins, fig.dim=c(6, 8)}
## heatmaps were generated by [ComplexHeatmap](https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html)
## construct the matrix for heatmap input
all_stat_heatmap_matrix <-
  all_stat %>%
  dplyr::select(matches("Gene|_vs_")) %>%
  as.matrix() %>%
  `rownames<-`(.[, "Gene_names"]) %>%
  `colnames<-`(sapply(colnames(.), function(x) str_replace(x, "^[A-Za-z]{1}_", ""))) %>%
  `colnames<-`(sapply(colnames(.), function(x) str_replace_all(x, "_", " "))) %>%
  .[, !colnames(.) %in% c("Gene names")] %>%
  `class<-`("numeric")

## Same with heatmap for sig proteins
all_stat_heatmap_ha_df <-
  data.frame(type = colnames(all_stat_heatmap_matrix)) %>%
  mutate(Comparison = str_extract(type, ".+(?= [0-9]{1}$)")) %>%
  dplyr::select(-type)

## construct the customised annotation
all_stat_heatmap_ha <-
  columnAnnotation(
    df = all_stat_heatmap_ha_df,
    col = list(Comparison = setNames(
      brewer.pal(6, "RdBu")[1:5],
      sort(unique(all_stat_heatmap_ha_df$Comparison))
    ) %>% sort(.)),
    annotation_legend_param = list(Comparison = list(
      nrow = 3,
      title = "Comparison",
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 6)
    ))
  )

## set the seed for reproducibility
set.seed(123)

all_stat_heatmap <-
  Heatmap(all_stat_heatmap_matrix,
    top_annotation = all_stat_heatmap_ha,
    heatmap_legend_param = list(
      title = "Log2 Fold Change",
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 6),
      legend_direction = "horizontal",
      legend_width = unit(1.5, "in")
    ),
    show_column_names = FALSE,
    show_row_names = FALSE,
    show_row_dend = FALSE
  )

draw(all_stat_heatmap, heatmap_legend_side = "bottom", annotation_legend_side = "bottom")

for (an in colnames(all_stat_heatmap_ha_df)) {
  decorate_annotation(an, {
    ## annotation names on the left
    grid.text(an,
      unit(1, "npc") + unit(2, "mm"),
      0.6,
      default.units = "npc",
      just = "left",
      gp = gpar(fontsize = 8)
    )
  })
}
```

We submitted the identified proteins to DAVID database to investigate the cellular compartments they belong to.

```{r david-GO-analysis}
## cell compartment GO analysis
all_stat_gene <- all_stat %>% pull(Gene_names)
all_stat_gene_ENTREZID <- mapIds(org.Mm.eg.db,
                                 keys = all_stat_gene,
                                 column = "ENTREZID",
                                 keytype = "SYMBOL",
                                 multiVals = "first") %>% na.omit

## gene list was searched against DAVID database https://david.ncifcrf.gov
david_gene <- readr::read_tsv("https://david.ncifcrf.gov/data/download/chart_94533FFDBC301547014607513.txt")

## save it locally
## write_tsv(david_gene, glue(path, "all-stat-gene-DAVID-database-GO-cell-compartment.txt"))

p_go_cell_compartment <-
  ggplot(david_gene %>%
         filter(FDR < 0.05) %>%
         arrange(Count) %>%
         mutate(Term = factor(Term, Term)),
       aes(Term, Count)) +
  geom_bar(stat = "identity",
           fill = "#cccccc") +
  scale_y_continuous(breaks = seq(0, 1500, 300),
                     limits = c(0, 1600),
                     expand = c(0, 0)) +
  coord_flip()

p_go_cell_compartment
```

### Analysis of proteins with significant abundance changes

We moved to investigate the proteins with different abundance in at least one comparison group. First the cluster was defined by k-means clustering and 9 was chosen.

```{r potential-cluster-number, fig.dim=c(6, 6)}
## Annotation is same with heatmap for all proteins

sig_stat_heatmap_df <-
  all_stat %>%
  filter(Sig_diff == TRUE) %>%
  dplyr::select(matches("Gene|_vs_")) %>%
  `colnames<-`(sapply(colnames(.), function(x) str_replace(x, "^[A-Za-z]{1}_", ""))) %>%
  `colnames<-`(sapply(colnames(.), function(x) str_replace_all(x, "_", " ")))

## determine the potential cluster numbers
fviz_nbclust(sig_stat_heatmap_df %>% dplyr::select(-matches("Gene")),
  kmeans,
  method = "wss"
)
```

The heatmap was generated with 9 clusters.

```{r, heatmap-for-signifant, fig.dim=c(6, 15)}
sig_stat_heatmap_df <-
  sig_stat_heatmap_df %>%
  mutate(cluster = kmeans(sig_stat_heatmap_df %>% dplyr::select(-matches("Gene")), 9)$cluster)

sig_stat_heatmap_matrix <-
  sig_stat_heatmap_df %>%
  as.matrix() %>%
  `rownames<-`(.[, "Gene names"]) %>%
  .[, !colnames(.) %in% c("Gene names")] %>%
  `class<-`("numeric")

sig_stat_heatmap_ha_row <-
  rowAnnotation(
    df = sig_stat_heatmap_df %>% dplyr::select(cluster) %>% as.data.frame(),
    col = list(cluster = setNames(
      brewer.pal(9, "BrBG"),
      unique(sig_stat_heatmap_df$cluster) %>% sort(.)
    )),
    width = unit(0.2, "in"),
    annotation_legend_param = list(
      nrow = 1,
      title = "Cluster",
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 8),
      legend_width = unit(1, "in")
    )
  )

set.seed(123)
sig_stat_heatmap <-
  Heatmap(sig_stat_heatmap_matrix[, !colnames(sig_stat_heatmap_matrix) %in% c("cluster")],
    top_annotation = all_stat_heatmap_ha,
    heatmap_legend_param = list(
      title = "Log2 Fold Change",
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 6),
      legend_direction = "horizontal",
      legend_width = unit(1.5, "inch")
    ),
    show_column_names = FALSE,
    show_row_dend = FALSE,
    combined_name_fun = NULL,
    row_names_gp = gpar(fontsize = 6),
    split = sig_stat_heatmap_matrix[, "cluster"],
    gap = unit(1.5, "mm")
  )

draw(sig_stat_heatmap_ha_row + sig_stat_heatmap, heatmap_legend_side = "bottom", annotation_legend_side = "bottom")

for (an in colnames(all_stat_heatmap_ha_df)) {
  decorate_annotation(an, {
    ## annotation names on the left
    grid.text(an,
      unit(1, "npc") + unit(2, "mm"),
      0.6,
      default.units = "npc",
      just = "left",
      gp = gpar(fontsize = 8)
    )
  })
}
```

All analyses above were only about all proteins from different comparison group. To identify proteins in each comparison group, we visualized data with volcano plots. The dataset was first cleaned for the subsequent visualization.

```{r volcano-plot-data-cleaning}
all_stat_volcano <- all_stat %>% as.data.table()
Comparison_list <- c("A", "B", "C", "b", "c")
for (i in seq_along(Comparison_list)) {
  logical_p <- paste0(Comparison_list[i], "_p_value")
  logical_mean <- paste0(Comparison_list[i], "_mean")
  all_stat_volcano[, Comparison_list[i] := ifelse(get(logical_p) <= 0.05 & get(logical_mean) >= 1, "up", ifelse(get(logical_p) <= 0.05 & get(logical_mean) <= -1, "down", "ns"))]
}
```

We also customized a function for generating volcano plots.

```{r volcano-plot-function}
geom_volcano <- function(data = data, type = type, gene = gene_list)
{
  x = paste0(type, "_mean")
  y = paste0(type, "_p_value")
  title = str_extract(colnames(data), sprintf("^%s_.+", type)) %>% unique() %>% str_extract(., "(?<=[A-Za-z]_).+(?=_[0-9]$)") %>% str_replace_all(., "_", " ") %>% na.omit()
  data <- mutate_at(data, vars(y), funs(-log10(.)))
  x_limits = c(-6, 6)
  y_limits = c(0, 6)
  x_breaks = seq(min(x_limits), max(x_limits), 2)
  y_breaks = seq(min(y_limits), max(y_limits), 1)
  point_colour = setNames(c(brewer.pal(11, "RdBu")[2], "gray50", brewer.pal(11, "RdBu")[10]),
                          c("up", "ns", "down"))
  down_regulated_number = data %>% filter(get(x) <= -1, get(y) > -log10(0.05)) %>%  nrow(.)
  up_regulated_number = data %>% filter(get(x) >= 1, get(y) > -log10(0.05)) %>%  nrow(.)

  ggplot(data, aes_string(x, y)) +
    geom_point(aes_string(color = type), size = 2) +
    geom_vline(xintercept = c(-1, 1),
               linetype = "dashed",
               color = "gray50",
               size = 0.25) +
    geom_hline(yintercept = -log10(0.05),
               linetype =  "dashed",
               color = "gray50",
               size = 0.25) +
    geom_text_repel(data = . %>% filter(Gene_names %in% gene,
                                        get(type) == "down" | get(type) == "up"),
                    aes(label = Gene_names),
                    size = 4,
                    segment.size = 0.25,
                    nudge_y = 0.5
                    ) +
    annotate("text",
             x = min(x_limits),
             y = max(y_limits),
             label = paste("Downregulated gene: ", down_regulated_number),
             hjust = 0,
             size = 4) +
    annotate("text",
             x = max(x_limits),
             y = max(y_limits),
             label = paste("Upregulated gene: ", up_regulated_number),
             hjust = 1,
             size = 4) +
    labs(title = title, x = "Log2 Fold Change", y = "-Log10(p value)") +
    scale_x_continuous(limits = x_limits, breaks = x_breaks) +
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +
    scale_color_manual(values = point_colour, guide = FALSE) +
    theme_classic() +
    theme(
          axis.line.x = element_line(size = 0.25),
          axis.line.y = element_line(size = 0.25),
          axis.ticks.x  = element_line(size = 0.25),
          axis.ticks.y  = element_line(size = 0.25),
          axis.title = element_text(size = 10),
          axis.text = element_text(size = 8),
          plot.title = element_text(size = 12,
                               face = "plain"))
}
```

The volcano plots were shown below.

```{r volcano-plot-list, fig.dim=c(15, 10)}
gene_list <- c("Oas3", "Isg15", "Ifi204", "Ifit1", "Gbp2", "Gbp7", "Cmpk2", "Ddx58", "Gvin1", "Selenbp1;Selenbp2", "Rnf213", "Lgals9", "Dtx3l", "Fth1", "Il1rn", "Mmp9", "Mmp8", "Lrg1", "F5", "Retnlg", "Ltf", "Il1f9;Il36g", "Lcn2", "Mcm2", "Dnmt1",  "Lig1", "Btf3")

volcano_g <- lapply(c("A", "B", "C", "b", "c"), function(x) geom_volcano(data = all_stat_volcano,
                                                                         type = x,
                                                                         gene = gene_list))

plot_grid(plotlist = volcano_g[c(1, 2, 4, 3, 5)], nrow = 2)
```

We are also interested in the pathways these proteins involved. Therefore, we filtered the proteins and annotated them as down or up. They were used to search the Reactome database respectively and retrieved the pathway data for visualization.

```{r pathway-analysis}
## as of 16 Oct 2018
all_stat_pathway <-
  all_stat %>%
  as_tibble() %>%
  dplyr::filter(Sig_diff == TRUE & !(abs(c_mean) >= 1 & c_p_value < 0.05)) %>%
  dplyr::select(Gene_names, A_mean, A_p_value, C_mean, C_p_value, b_mean, b_p_value) %>%
  mutate(`1000_pfu_PR8_BAL_vs_1000_pfu_PR8_Blood_direction` = ifelse(A_mean < -1 & A_p_value < 0.05, "down", ifelse(A_mean > 1 & A_p_value < 0.05, "up", "ns")),
         `1000_pfu_PR8_Blood_vs_1000_pfu_PR8_BM_direction` = ifelse(C_mean < -1 & C_p_value < 0.05, "down", ifelse(C_mean > 1 & C_p_value < 0.05, "up", "ns")),
         `1000_pfu_PR8_BM_vs_pbs_BM_direction` = ifelse(b_mean < -1 & b_p_value < 0.05, "down", ifelse(b_mean > 1 & b_p_value < 0.05, "up", "ns")))

purrr::map(c("1000_pfu_PR8_BAL_vs_1000_pfu_PR8_Blood", "1000_pfu_PR8_Blood_vs_1000_pfu_PR8_BM", "1000_pfu_PR8_BM_vs_pbs_BM"),
           function(x) {
             direction <- sym(glue::glue(x, "_direction"))

             assign(glue::glue(x, "_down"),
                    all_stat_pathway %>%
                      dplyr::filter(!!direction == "down") %>%
                      pull(Gene_names),
                    envir = .GlobalEnv)

             assign(glue::glue(x, "_up"),
                    all_stat_pathway %>%
                      dplyr::filter(!!direction == "up") %>%
                      dplyr::pull(Gene_names),
                    envir = .GlobalEnv)
           }) %>% rm(.)
```

Because in blood tissues, many proteins related to ribisome were downregulated and they would interfere the final outputs. To address this, we separated them first and proceeded to visualization.

```{r pathway-data-cleaning}
pathway_file <- glue::glue(path, "/20181018-reactome-pathway-analysis.xlsx")

Comparison_name_conversion <-
  setNames(c("1000_pfu_PR8_BAL_vs_1000_pfu_PR8_Blood",
             "1000_pfu_PR8_Blood_vs_1000_pfu_PR8_BM",
             "1000_pfu_PR8_BM_vs_pbs_BM"),
           c("flu_bal_vs_flu_blood",
             "flu_blood_vs_flu_bm",
             "flu_bm_vs_pbs_bm"))

Pathway_all <-
  purrr::map((readxl::excel_sheets(pathway_file)),
    function(i){
      assign(glue::glue("pathway_", i),
             readxl::read_excel(pathway_file, sheet = i) %>%
               dplyr::select(`Pathway name`, `#Entities found`, `Entities FDR`, `Submitted entities found`) %>%
               magrittr::set_colnames(c("Pathway", "Found", "FDR", "Submitted_found")) %>%
               dplyr::filter(FDR < 0.05 & Found > 2) %>%
               mutate(Entries = str_split(Submitted_found, ";"),
                      Down = map(1:nrow(.), ~ get(glue::glue(Comparison_name_conversion[i], "_down"))),
                      Up = map(1:nrow(.), ~ get(glue::glue(Comparison_name_conversion[i], "_up")))) %>%
               mutate(Down_no = map2(.$Entries, .$Down, ~ intersect(.x, .y)) %>% map(length) %>% as.numeric(),
                      Up_no = map2(.$Entries, .$Up, ~ intersect(.x, .y)) %>% map(length) %>% as.numeric(),
                      Database_extra_no = Found - Down_no - Up_no,
                      Comparison = rep(i, nrow(.))),
             envir = .GlobalEnv)
      }
    ) %>%
  purrr::reduce(bind_rows)

## There are lots of ribosome-related proteins in the blood compartments.
## To ease visualization, we separated the
## pathways into two groups.
## - pathways involves the ribosome proteins
## - pathways excludes the ribosome proteins
Pathway_all_Blood <-
  Pathway_all %>%
  dplyr::filter(grepl("^Rp", Submitted_found)) %>%
  ##  dplyr::filter(!grepl("^Rp", Submitted_found)) %>%
  dplyr::filter(!Pathway %in% c("Immune System")) %>%
  mutate(p_y = setNames(1:length(.$Pathway %>% unique), .$Pathway %>% unique %>% sort(decreasing = T))[Pathway] %>% as.numeric(),
         c_x = setNames(1:length(.$Comparison %>% unique), .$Comparison %>% unique %>% sort(decreasing = T))[Comparison] %>% as.numeric()) %>%
  mutate(radius = sqrt(Found/40))

Pathway_all_exclude_Blood <-
  Pathway_all %>%
  dplyr::filter(!grepl("^Rp", Submitted_found)) %>%
  dplyr::filter(!Pathway %in% c("Immune System")) %>%
  mutate(p_y = setNames(1:length(.$Pathway %>% unique), .$Pathway %>% unique %>% sort(decreasing = T))[Pathway] %>% as.numeric(),
         c_x = setNames(1:length(.$Comparison %>% unique), .$Comparison %>% unique %>% sort(decreasing = T))[Comparison] %>% as.numeric()) %>%
  mutate(radius = sqrt(Found/40))
```

We first checked the proteins without ribisome "contamination".

```{r pathway-exclude-ribosomes, fig.dim = c(10, 15)}
g_pathway_exclue_Blood <-
  ggplot(data = Pathway_all_exclude_Blood) +
  geom_scatterpie(aes(x = c_x, y = p_y, r = radius), color = "transparent", cols = c("Down_no", "Up_no", "Database_extra_no"), data = Pathway_all_exclude_Blood) +
  scale_y_continuous(limits = c(-2, 36), breaks = seq(1, 35, 1), labels = unique(Pathway_all_exclude_Blood$Pathway) %>% sort(decreasing = T))  +
  scale_x_continuous(labels = c("1000 pfu PR8 BM vs pbs BM",
                                "1000 pfu PR8 Blood vs 1000 pfu PR8 BM",
                                "1000 pfu PR8 BAL vs 1000 pfu PR8 Blood"
                              ),
                   breaks = c(1, 2, 3)) +
  coord_equal()  +
  scale_fill_manual(values = c("#000000", "#d7191c", "#2b83ba")) +
  geom_scatterpie_legend(Pathway_all_exclude_Blood$radius,
                         x = 1,
                         y = -2,
                         labeller=function(x) x=c(3, 7, 11, 15)
                         ) +
  theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab(NULL) +
  xlab(NULL)

g_pathway_exclue_Blood
```

And then the proteins related to ribisomes were visualized.

```{r pathway-include-ribosomes, fig.dim = c(10, 15)}
g_pathway_Blood <-
  ggplot(data = Pathway_all_Blood) +
  geom_scatterpie(aes(x = c_x + 1, y = p_y, r = radius), color = "transparent", cols = c("Down_no", "Up_no", "Database_extra_no"), data = Pathway_all_Blood) +
  scale_y_continuous(limits = c(-2, 40), breaks = seq(1, 39, 1), labels = unique(Pathway_all_Blood$Pathway) %>% sort(decreasing = T))  +
  scale_x_continuous(labels = c("",
                                "1000 pfu PR8 Blood vs 1000 pfu PR8 BM",
                                ""
                                ),
                     limits = c(0.5, 3.5),
                     breaks = c(1, 2, 3)) +
  coord_equal()  +
  scale_fill_manual(values = c("#000000", "#d7191c", "#2b83ba")) +
  geom_scatterpie_legend(Pathway_all_Blood$radius,
                         x = 1,
                         y = -2,
                         labeller=function(x) x=c(3, 7, 11, 15)) +
  theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab(NULL) +
  xlab(NULL)

g_pathway_Blood
```

Finally we used the alluvival flow to show the protein abundance changes from PBS BM to 1000 pfu PR8 BM and then Blood and BAL.

```{r ggalluvial, fig.dim=c(6, 15)}
g_alluvial <-
  ggplot(all_stat_pathway %>%
         dplyr::select(1, 8:10) %>%
         gather(key, value, 2:4) %>%
         mutate(freq = 1,
                value = factor(value, levels = c("up", "ns", "down")),
                key = factor(key, levels = c("1000_pfu_PR8_BM_vs_pbs_BM_direction",
                                             "1000_pfu_PR8_Blood_vs_1000_pfu_PR8_BM_direction",
                                             "1000_pfu_PR8_BAL_vs_1000_pfu_PR8_Blood_direction"))),
       aes(key, freq, stratum = value, alluvium = Gene_names, fill = value, label = Gene_names)) +
  geom_stratum(alpha = .5) +
  geom_flow() +
  geom_text(stat = "alluvium", size = 3) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        plot.margin=margin(5,5,5,50,unit="pt")) +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("1000 pfu PR8 BM vs PBS BM",
                              "1000 pfu PR8 Blood vs 1000 pfu PR8 BM",
                              "1000 pfu PR8 BAL vs 1000 pfu PR8 Blood"))

g_alluvial
```

### iBAQ intensity ranking

The intensity data were extracted from iBAQ values and only the proteins identified in both experiments were used.

```{r intensity-data-preparation}
## customise a function to convert `0` to `NA` that is compatible with our previous defined function.
is_zero <- function(x) { ifelse(x == 0, TRUE, FALSE)}

data_nov_intensity <-
  raw_data_nov %>%
  dplyr::select(matches("Gene names|iBAQ\\s[A-Z]{1}\\sRep[0-9]+$")) %>%
    magrittr::set_colnames(c("Gene_names",
                           "A_1st_1000_PFU_PR8_BM_1",
                           "B_1st_1000_PFU_PR8_Blood_1",
                           "C_1st_1000_PFU_PR8_BAL_1",
                           "C_1st_1000_PFU_PR8_BAL_2",
                           "A_1st_1000_PFU_PR8_BM_2",
                           "B_1st_1000_PFU_PR8_Blood_2",
                           "B_1st_1000_PFU_PR8_Blood_3",
                           "C_1st_1000_PFU_PR8_BAL_3",
                           "A_1st_1000_PFU_PR8_BM_3")) %>%
  dplyr::filter(!is.na(Gene_names)) %>%
  distinct(Gene_names, .keep_all = TRUE) %>%
  as.data.table()

## To make the iBAQ dataset compatible with our `filter_valid` function.
data_nov_intensity[is_zero(data_nov_intensity)] <- NA

valid_list <- c("tissue", "1", "2", "3")
for (i in valid_list) {
  data_nov_intensity[,
           sprintf("rep_%s_valid", i) := filter_valid(.SD),
           .SDcols = names(data_nov_intensity) %like% ifelse(i == "tissue", "^[ABC]_.+_[0-9]$", sprintf("_%s$", i))]
}

data_nov_intensity <-
  data_nov_intensity %>%
  as_tibble() %>%
  dplyr::filter(rep_tissue_valid == TRUE) %>%
  dplyr::select(-matches("valid$")) %>%
  tidyr::gather(group, value, -Gene_names)

data_dec_intensity <-
  raw_data_dec %>%
  dplyr::select(matches("Gene names|iBAQ\\s[A-Z]{1}\\sRep[0-9]+$")) %>%
  magrittr::set_colnames(c(
    "Gene_names",
    "F_2nd_PBS_BM_1",
    "E_2nd_PBS_Blood_1",
    "D_2nd_1000_PFU_PR8_BM_1",
    "D_2nd_1000_PFU_PR8_BM_2",
    "F_2nd_PBS_BM_2",
    "E_2nd_PBS_Blood_2",
    "E_2nd_PBS_Blood_3",
    "D_2nd_1000_PFU_PR8_BM_3",
    "F_2nd_PBS_BM_3"
  )) %>%
  dplyr::filter(!is.na(Gene_names)) %>%
  distinct(Gene_names, .keep_all = TRUE) %>%
  as.data.table()

## To make the iBAQ dataset compatible with our `filter_valid` function.
data_dec_intensity[is_zero(data_dec_intensity)] <- NA

valid_list <- c("tissue", "1", "2", "3")
for (i in valid_list) {
  data_dec_intensity[,
           sprintf("rep_%s_valid", i) := filter_valid(.SD),
           .SDcols = names(data_dec_intensity) %like% ifelse(i == "tissue", "^[DEF]_.+_[0-9]$", sprintf("_%s$", i))]
}

data_dec_intensity <-
  data_dec_intensity %>%
  as_tibble() %>%
  dplyr::filter(rep_tissue_valid == TRUE) %>%
  dplyr::select(-matches("valid$")) %>%
  tidyr::gather(group, value, -Gene_names)

data_intensity <-
  bind_rows(data_nov_intensity, data_dec_intensity) %>%
  mutate(gene_count = 1) %>%
  group_by(Gene_names) %>%
  mutate(gene = sum(gene_count)) %>%
  dplyr::filter(gene == 18) %>%
  dplyr::select(-gene_count, -gene) %>%
  group_by(group) %>%
  mutate(ranking = dplyr::dense_rank(-value),
         percent = value / sum(value)) %>%
  arrange(-percent, group) %>%
  mutate(percent_cum = cumsum(percent))
```

```{r customised-function-for-intensity-ranking-visualization}
## Customise a function to draw ranking plots and insert a small plot which contains proteins accounting for 75% of total abundance.
geom_ranking <- function(df) {
  ranking_marker <- df %>% dplyr::slice(base::which.min(abs(percent_cum - 0.75))) %>% pull(ranking)

  df_annotation <- df %>% dplyr::filter(ranking <= ranking_marker)

  title <- df$group %>% unique() %>% toString() %>% stringr::str_replace_all("_", " ") %>% stringr::str_replace_all("^[A-F]\\s", "")

  p <-
    ggplot(df, aes(ranking, percent_cum)) +
    geom_line() +
    geom_point() +
    labs(title = title,
         y = NULL,
         x = NULL) +
    scale_x_continuous(breaks = seq(0, 2000, 200),
                       labels = seq(0, 2000, 200),
                       limits = c(0, 2000)) +
    scale_y_continuous(breaks = seq(0, 1, 0.1)) +
    theme(axis.title = element_text(size = 10),
          axis.text = element_text(size = 8),
          plot.title = element_text(size = 12,
                                    face = "plain",
                                    hjust = 0.5))

  x_max <- df_annotation %>% pull(ranking) %>% max()
  y_max <- df_annotation %>% dplyr::filter(ranking == x_max) %>% pull(percent_cum)

  p_annotation <-
    ggplotGrob(
      ggplot(df_annotation, aes(ranking, percent_cum)) +
        geom_line() +
        geom_point() +
        geom_segment(aes(x = 0,
                         xend = x_max,
                         y = y_max,
                         yend = y_max),
                     linetype = "dashed") +
        geom_segment(aes(x = x_max,
                         xend = x_max,
                         y = 0,
                         yend = y_max,),
                     linetype = "dashed") +
        scale_x_continuous(limits = c(0, 80),
                           breaks = c(seq(0, 40, 10), x_max, 80),
                           labels = c(seq(0, 40, 10), x_max, 80),
                         expand = expand_scale(mult = c(0, 0.01),
                                               add = c(0, 0))) +
        scale_y_continuous(breaks = seq(0, 0.80, 0.1),
                           expand = expand_scale(mult = c(0, 0.05),
                                         add = c(0, 0))) +
        expand_limits(c(0, 0)) +
        labs(y = NULL,
             x = NULL) +
        theme_bw() +
        theme(axis.title = element_text(size = 10),
              axis.text = element_text(size = 8))
    )

  p + annotation_custom(
    grob = p_annotation,
    xmin = 500,
    xmax = 1900,
    ymin = 0.1,
    ymax = 0.85
  )
}
```

```{r visualised-intensity-ranking, fig.dim=c(16, 20)}
ranking_plot <-
  purrr::map(
    data_intensity$group %>% unique() %>% stringr::str_sort(),
    ~ geom_ranking(dplyr::filter(data_intensity, group == .x))
)

cowplot::plot_grid(plotlist = ranking_plot,
                   ncol = 3,
                   scale = 0.9) + ## reduce this for a bit more space
  cowplot::draw_label("Ranking",
                      x = 0.5,
                      y = 0,
                      vjust = -0.5,
                      angle = 0) +
  cowplot::draw_label("Cumulative proportion",
                      x = 0,
                      y = 0.5,
                      vjust = 1.5,
                      angle = 90)
```

## Analysis of BAL neutrophil proteome changes following different doses of influenza infection or bacterial infection

### Raw data cleaning

The labelling details are below:

| Labelling  | Sample                                            |
| :--------- | :------------------------------------------------ |
| Light (L)  | 100 pfu PR8 BAL neutrophil                        |
| Medium (M) | 1000 pfu PR8 BAL neutrophil                       |
| Heavy (H)  | 10^6^ CFU *Pseudomonas Aeruginosa* BAL neutrophil |

Table: **Experiment 3 Biological replicate 1**

| Labelling  | Sample                                            |
| :--------- | :------------------------------------------------ |
| Light (L)  | 1000 PFU PR8 BAL neutrophil                       |
| Medium (M) | 10^6^ CFU *Pseudomonas Aeruginosa* BAL neutrophil |
| Heavy (H)  | 100 pfu PR8 BAL neutrophil                        |

Table: **Experiment 3 Biological replicate 2**

| Labelling  | Sample                                            |
| :--------- | :------------------------------------------------ |
| Light (L)  | 10^6^ CFU *Pseudomonas Aeruginosa* BAL neutrophil |
| Medium (M) | 100 PFU PR8 BAL neutrophil                        |
| Heavy (H)  | 1000 PFU PR8 BAL neutrophil                       |

Table: **Experiment 3 Biological replicate 3**

We first tried data cleaning for this dataset. The proteins with different abundance were also filtered out.

```{r raw-data-cleaning-for-the-third-exp, warning=FALSE}
data_201712 <-
  read_tsv(glue::glue(path, "/20180206-Proteomics-201801-Requant.txt")) %>%
  filter(is.na(.$`Only identified by site`) & is.na(.$Reverse) &  is.na(.$`Potential contaminant`) & `Razor + unique peptides` >= 1) %>%
  dplyr::select(matches("Gene names|normalized Rep")) %>%
  magrittr::set_colnames(c("Gene_names",
                           "A_1000_PFU_PR8_vs_100_PFU_PR8_1",
                           "B_10^6_CFU_Pseudomonas_vs_1000_PFU_PR8_2",
                           "C_10^6_CFU_Pseudomonas_vs_100_PFU_PR8_3_invert",
                           "C_10^6_CFU_Pseudomonas_vs_100_PFU_PR8_1",
                           "A_1000_PFU_PR8_vs_100_PFU_PR8_2_invert",
                           "B_10^6_CFU_Pseudomonas_vs_1000_PFU_PR8_3_invert",
                           "B_10^6_CFU_Pseudomonas_vs_1000_PFU_PR8_1",
                           "C_10^6_CFU_Pseudomonas_vs_100_PFU_PR8_2_invert",
                           "A_1000_PFU_PR8_vs_100_PFU_PR8_3")) %>%
  mutate_at(vars(contains("invert")), funs(1/.)) %>%
  magrittr::set_colnames(sapply(colnames(.), function(x) str_replace(x, "_invert", ""))) %>%
  mutate_at(vars(-Gene_names), funs(log2(.))) %>%
  as.data.table()

for (i in valid_list) {
  data_201712[,
              sprintf("rep_%s_valid", i) := filter_valid(.SD),
              .SDcols = names(data_201712) %like% ifelse(i == "tissue",
                                                         "^[ABC]_.+_[0-3]$",
                                                         sprintf("_%s$", i))]
}

data_201712_stat <-
  data_201712 %>%
  filter(rep_tissue_valid == TRUE) %>%
  dplyr::select(-matches("valid$")) %>%
  as.data.table()

for (i in c("A", "B", "C")) {
  data_201712_stat[,
                   c(sprintf("%s_p_value", i),
                     sprintf("%s_mean", i))   := list(apply(.SD, 1, function(x) t.test(x)$p.value),
                                                      apply(.SD, 1, function(x) mean(x))),
                   .SDcols = names(data_201712_stat) %like% sprintf("^%s.+[0-9]$", i)]
}

data_201712_stat <-
  data_201712_stat %>%
  as_data_frame() %>%
  dplyr::select(Gene_names, everything()) %>%
  mutate(sig = (A_p_value <0.05 & abs(A_mean) > 1)|(B_p_value < 0.05&abs(B_mean) > 1) | (C_p_value < 0.05 & abs(C_mean) > 1))
```

### Overall impression of datasets

Then we generated a PCA analysis to look at the protein abundance pattern.

```{r PCA-plot-for-the-proteome-involved-bacterial-infection, fig.dim=c(8, 8)}
set.seed(2018)
pca_matrix_201712 <-
  data_201712_stat %>%
  as_data_frame() %>%
  dplyr::select(matches("_1|_2|_3")) %>%
  as.matrix %>%
  princomp(., cor = T)

pca_matrix_pov_201712 <- pca_matrix_201712$sdev^2/sum(pca_matrix_201712$sdev^2)

pca_df_201712 <- pca_matrix_201712$loadings[] %>%
  as.data.frame %>%
  mutate(Sample = row.names(.)) %>%
  mutate(Categories = str_extract(Sample, "(?<=[A-Z]{1}_).+(?=_[0-9]{1})")) %>%
  mutate(Batch = str_extract(Sample, "[0-9]{1}$"))

ggplot(pca_df_201712, aes(Comp.1, Comp.2, color = Categories)) +
  geom_point(size = 4) +
  geom_text_repel(aes(label = Batch)) +
  labs(x = sprintf("PC1: %.3f %% Variance", pca_matrix_pov_201712["Comp.1"]*100),
       y = sprintf("PC2: %.3f %% Variance", pca_matrix_pov_201712["Comp.2"]*100)) +
  scale_color_manual(values = brewer.pal(6, "RdBu")[c(1,3, 5)]) +
  theme_classic() +
  theme(aspect.ratio = 1,
        panel.border = element_rect(fill = "transparent",
                                    color = "black"))
```
### Analysis of proteins with significant abundance changes

Lastly, a heatmap for all proteins with different abundance detected in at least one group was visualized.

```{r heatmap-data-preparation}
data_201712_heatmap_ha_df <-
  data.frame(type = colnames(data_201712 %>% dplyr::select(-matches("valid|Gene")))) %>%
  mutate(Comparision = str_extract(type, "(?<=[ABC]_).+(?=_[0-9]{1}$)")) %>%
  dplyr::select(-type)

data_201712_heatmap_ha <-
  columnAnnotation(
    df = data_201712_heatmap_ha_df,
    col = list(
      Comparision = setNames(
        brewer.pal(6, "RdBu")[c(1,3, 5)],
        sort(data_201712_heatmap_ha_df %>% pull(Comparision) %>% unique))),
    annotation_legend_param = list(
      Comparision = list(
        nrow = 3,
        title = "Comparison",
        title_gp = gpar(fontsize = 8),
        labels_gp = gpar(fontsize = 6)
      )
    )
  )
```

The cluster number was first determined by ***fviz_nbclust*** function.

```{r determine-the-clusters-for-data_201712, fig.dim=c(6, 6)}
data_201712_sig_heatmap_df <-
  data_201712_stat %>%
  dplyr::filter(sig == TRUE) %>%
  dplyr::select(matches("Gene|_vs_")) %>%
  `colnames<-`(sapply(colnames(.), function(x) str_replace(x, "^[A-Za-z]{1}_", ""))) %>%
  `colnames<-`(sapply(colnames(.), function(x) str_replace_all(x, "_", " ")))

factoextra::fviz_nbclust(data_201712_sig_heatmap_df %>% dplyr::select(-matches("Gene")),
  kmeans,
  method = "wss"
)
```

Based on the plot, we can 3 clusters are the best option to visualize the dataset.

```{r heatmap-for-the-proteome-involved-bacterial-infection, fig.dim=c(9, 10)}
data_201712_sig_heatmap_df <-
  data_201712_sig_heatmap_df %>%
  mutate(cluster = kmeans(data_201712_sig_heatmap_df %>% dplyr::select(-matches("Gene")), 3)$cluster)

data_201712_sig_stat_heatmap_matrix <-
  data_201712_sig_heatmap_df %>%
  as.matrix() %>%
  `rownames<-`(.[, "Gene names"]) %>%
  .[, !colnames(.) %in% c("Gene names")] %>%
  `class<-`("numeric")

data_201712_sig_stat_heatmap_ha_row <-
  rowAnnotation(
    df = data_201712_sig_heatmap_df %>% dplyr::select(cluster) %>% as.data.frame(),
    col = list(cluster = setNames(
      brewer.pal(3, "BrBG"),
      data_201712_sig_heatmap_df %>% pull(cluster) %>% unique() %>% sort(.)
    )
    ),
    width = unit(0.2, "in"),
    annotation_legend_param = list(
      nrow = 1,
      title = "Cluster",
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 8),
      legend_width = unit(1, "in")
    )
  )

set.seed(123)
data_201712_sig_stat_heatmap <-
  Heatmap(data_201712_sig_stat_heatmap_matrix[, !colnames(data_201712_sig_stat_heatmap_matrix) %in% c("cluster")],
    top_annotation = data_201712_heatmap_ha,
    heatmap_legend_param = list(
      title = "Log2 Fold Change",
      title_gp = gpar(fontsize = 8),
      labels_gp = gpar(fontsize = 8),
      legend_direction = "horizontal",
      legend_width = unit(1.5, "inch")
    ),
    show_column_names = FALSE,
    show_row_dend = FALSE,
    combined_name_fun = NULL,
    row_names_gp = gpar(fontsize = 8),
    split = data_201712_sig_stat_heatmap_matrix[, "cluster"],
    gap = unit(1.5, "mm")
  )


draw(data_201712_sig_stat_heatmap_ha_row + data_201712_sig_stat_heatmap, heatmap_legend_side = "bottom", annotation_legend_side = "bottom")

for (an in colnames(data_201712_heatmap_ha_df)) {
  decorate_annotation(an, {
    ## annotation names on the left
    grid.text(an,
      unit(1, "npc") + unit(2, "mm"),
      0.6,
      default.units = "npc",
      just = "left",
      gp = gpar(fontsize = 8)
    )
  })
}
```